<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="Log,">





  <link rel="alternate" href="/atom.xml" title="Just do it" type="application/atom+xml">






<meta name="description" content="This article recorded how to install and configure Log System based on Loki developing by Grafana.">
<meta name="keywords" content="Log">
<meta property="og:type" content="article">
<meta property="og:title" content="Loki Log System">
<meta property="og:url" content="http://blog.gcalls.cn/2022/03/Loki-Log-System.html">
<meta property="og:site_name" content="Just do it">
<meta property="og:description" content="This article recorded how to install and configure Log System based on Loki developing by Grafana.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/zookeeper01.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/zookeeper02.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/01.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/02.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/03.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/04.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/10.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/05.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/06.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/07.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/08.png">
<meta property="og:image" content="http://blog.gcalls.cn/images/Loki-Log-System/09.png">
<meta property="og:updated_time" content="2024-07-25T07:36:00.053Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Loki Log System">
<meta name="twitter:description" content="This article recorded how to install and configure Log System based on Loki developing by Grafana.">
<meta name="twitter:image" content="http://blog.gcalls.cn/images/Loki-Log-System/zookeeper01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.gcalls.cn/2022/03/Loki-Log-System.html">





  <title>Loki Log System | Just do it</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0af0c9cfcd648be735ccf119d51ae564";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Just do it</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.gcalls.cn/2022/03/Loki-Log-System.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaoxunyong">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Just do it">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Loki Log System</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-03-09T16:04:26+08:00">
                2022-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Log/" itemprop="url" rel="index">
                    <span itemprop="name">Log</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/03/Loki-Log-System.html" class="leancloud_visitors" data-flag-title="Loki Log System">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>This article recorded how to install and configure Log System based on Loki developing by Grafana.</p>
<a id="more"></a>
<h2 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h2><h3 id="Kakfa-k8s"><a href="#Kakfa-k8s" class="headerlink" title="Kakfa k8s"></a>Kakfa k8s</h3><p>It’s complex, please refer to Kakfa Config: <a href="/files/Loki-Log-System/kafka.zip">kafka.zip</a></p>
<p>Kakfa without zookeeper:</p>
<ul>
<li><a href="https://learnk8s.io/kafka-ha-kubernetes#deploying-a-3-node-kafka-cluster-on-kubernetes" target="_blank" rel="noopener">https://learnk8s.io/kafka-ha-kubernetes#deploying-a-3-node-kafka-cluster-on-kubernetes</a></li>
<li><a href="https://stackoverflow.com/questions/73380791/kafka-kraft-replication-factor-of-3" target="_blank" rel="noopener">https://stackoverflow.com/questions/73380791/kafka-kraft-replication-factor-of-3</a></li>
<li><a href="https://github.com/IBM/kraft-mode-kafka-on-kubernetes" target="_blank" rel="noopener">https://github.com/IBM/kraft-mode-kafka-on-kubernetes</a></li>
</ul>
<p>Dockerfile:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:17-bullseye</span><br><span class="line"></span><br><span class="line">ENV KAFKA_VERSION=3.3.2</span><br><span class="line">ENV SCALA_VERSION=2.13</span><br><span class="line">ENV KAFKA_HOME=/opt/kafka</span><br><span class="line">ENV PATH=<span class="variable">$&#123;PATH&#125;</span>:<span class="variable">$&#123;KAFKA_HOME&#125;</span>/bin</span><br><span class="line"></span><br><span class="line">LABEL name=<span class="string">"kafka"</span> version=<span class="variable">$&#123;KAFKA_VERSION&#125;</span></span><br><span class="line"></span><br><span class="line">RUN wget -O /tmp/kafka_<span class="variable">$&#123;SCALA_VERSION&#125;</span>-<span class="variable">$&#123;KAFKA_VERSION&#125;</span>.tgz https://downloads.apache.org/kafka/<span class="variable">$&#123;KAFKA_VERSION&#125;</span>/kafka_<span class="variable">$&#123;SCALA_VERSION&#125;</span>-<span class="variable">$&#123;KAFKA_VERSION&#125;</span>.tgz \</span><br><span class="line"> &amp;&amp; tar xfz /tmp/kafka_<span class="variable">$&#123;SCALA_VERSION&#125;</span>-<span class="variable">$&#123;KAFKA_VERSION&#125;</span>.tgz -C /opt \</span><br><span class="line"> &amp;&amp; rm /tmp/kafka_<span class="variable">$&#123;SCALA_VERSION&#125;</span>-<span class="variable">$&#123;KAFKA_VERSION&#125;</span>.tgz \</span><br><span class="line"> &amp;&amp; ln -s /opt/kafka_<span class="variable">$&#123;SCALA_VERSION&#125;</span>-<span class="variable">$&#123;KAFKA_VERSION&#125;</span> <span class="variable">$&#123;KAFKA_HOME&#125;</span> \</span><br><span class="line"> &amp;&amp; rm -rf /tmp/kafka_<span class="variable">$&#123;SCALA_VERSION&#125;</span>-<span class="variable">$&#123;KAFKA_VERSION&#125;</span>.tgz</span><br><span class="line"></span><br><span class="line">COPY ./entrypoint.sh /</span><br><span class="line">RUN [<span class="string">"chmod"</span>, <span class="string">"+x"</span>, <span class="string">"/entrypoint.sh"</span>]</span><br><span class="line">ENTRYPOINT [<span class="string">"/entrypoint.sh"</span>]</span><br></pre></td></tr></table></figure>
<p>entrypoint.sh:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#NODE_ID=$&#123;HOSTNAME:6&#125;</span></span><br><span class="line">NODE_ID=$(hostname | sed s/.*-//)</span><br><span class="line">LISTENERS=<span class="string">"PLAINTEXT://:9092,CONTROLLER://:9093"</span></span><br><span class="line"><span class="comment">#ADVERTISED_LISTENERS="PLAINTEXT://kafka-$NODE_ID.$SERVICE.$NAMESPACE.svc.cluster.local:9092"</span></span><br><span class="line"><span class="comment">#ADVERTISED_LISTENERS="PLAINTEXT://kafka-$NODE_ID.$SERVICE:9092"</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$K8S_EXPOSE_BROKERS</span>"</span> == <span class="string">"true"</span> ]]; <span class="keyword">then</span></span><br><span class="line">  ADVERTISED_LISTENERS=<span class="string">"PLAINTEXT://<span class="variable">$HOST_IP</span>:9092"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  ADVERTISED_LISTENERS=<span class="string">"PLAINTEXT://kafka-<span class="variable">$NODE_ID</span>.<span class="variable">$SERVICE</span>:9092"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">CONTROLLER_QUORUM_VOTERS=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $( seq 0 <span class="variable">$REPLICAS</span>); <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$i</span> != <span class="variable">$REPLICAS</span> ]]; <span class="keyword">then</span></span><br><span class="line">        CONTROLLER_QUORUM_VOTERS=<span class="string">"<span class="variable">$CONTROLLER_QUORUM_VOTERS</span><span class="variable">$i</span>@kafka-<span class="variable">$i</span>.<span class="variable">$SERVICE</span>:9093,"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        CONTROLLER_QUORUM_VOTERS=<span class="variable">$&#123;CONTROLLER_QUORUM_VOTERS::-1&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$SHARE_DIR</span>/<span class="variable">$NODE_ID</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ ! -f <span class="string">"<span class="variable">$SHARE_DIR</span>/cluster_id"</span> &amp;&amp; <span class="string">"<span class="variable">$NODE_ID</span>"</span> = <span class="string">"0"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    CLUSTER_ID=$(kafka-storage.sh random-uuid)</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$CLUSTER_ID</span> &gt; <span class="variable">$SHARE_DIR</span>/cluster_id</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    CLUSTER_ID=$(cat <span class="variable">$SHARE_DIR</span>/cluster_id)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sed -e "s+^node.id=.*+node.id=$NODE_ID+" \</span></span><br><span class="line"><span class="comment"># -e "s+^controller.quorum.voters=.*+controller.quorum.voters=$CONTROLLER_QUORUM_VOTERS+" \</span></span><br><span class="line"><span class="comment"># -e "s+^listeners=.*+listeners=$LISTENERS+" \</span></span><br><span class="line"><span class="comment"># -e "s+^advertised.listeners=.*+advertised.listeners=$ADVERTISED_LISTENERS+" \</span></span><br><span class="line"><span class="comment"># -e "s+^log.dirs=.*+log.dirs=$SHARE_DIR/$NODE_ID+" \</span></span><br><span class="line"><span class="comment"># /opt/kafka/config/kraft/server.properties &gt; server.properties.updated \</span></span><br><span class="line"><span class="comment"># &amp;&amp; mv server.properties.updated /opt/kafka/config/kraft/server.properties</span></span><br><span class="line"></span><br><span class="line">sed -e <span class="string">"s+^node.id=.*+node.id=<span class="variable">$NODE_ID</span>+"</span> \</span><br><span class="line">-e <span class="string">"s+^controller.quorum.voters=.*+controller.quorum.voters=<span class="variable">$CONTROLLER_QUORUM_VOTERS</span>+"</span> \</span><br><span class="line">-e <span class="string">"s+^listeners=.*+listeners=<span class="variable">$LISTENERS</span>+"</span> \</span><br><span class="line">-e <span class="string">"s+^advertised.listeners=.*+advertised.listeners=<span class="variable">$ADVERTISED_LISTENERS</span>+"</span> \</span><br><span class="line">-e <span class="string">"s+^log.dirs=.*+log.dirs=<span class="variable">$SHARE_DIR</span>/<span class="variable">$NODE_ID</span>+"</span> \</span><br><span class="line">/opt/kafka/config/kraft/server.properties &gt; server.properties.updated</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;&gt; server.properties.updated</span><br><span class="line">default.replication.factor=<span class="variable">$&#123;DEFAULT_REPLICATION_FACTOR:=3&#125;</span></span><br><span class="line">min.insync.replicas=<span class="variable">$&#123;DEFAULT_MIN_INSYNC_REPLICAS:=2&#125;</span></span><br><span class="line">offsets.topic.replication.factor=<span class="variable">$&#123;DEFAULT_REPLICATION_FACTOR:=3&#125;</span></span><br><span class="line">transaction.state.log.replication.factor=<span class="variable">$&#123;DEFAULT_REPLICATION_FACTOR:=3&#125;</span></span><br><span class="line">transaction.state.log.min.isr=<span class="variable">$&#123;DEFAULT_MIN_INSYNC_REPLICAS:=2&#125;</span></span><br><span class="line">auto.create.topics.enable=<span class="variable">$&#123;KAFKA_AUTO_CREATE_TOPICS_ENABLE:=true&#125;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#sed -i "\$aauto.create.topics.enable=$KAFKA_AUTO_CREATE_TOPICS_ENABLE" server.properties.updated</span></span><br><span class="line"></span><br><span class="line">mv server.properties.updated /opt/kafka/config/kraft/server.properties</span><br><span class="line"></span><br><span class="line">kafka-storage.sh format -t <span class="variable">$CLUSTER_ID</span> -c /opt/kafka/config/kraft/server.properties</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> kafka-server-start.sh /opt/kafka/config/kraft/server.properties</span><br></pre></td></tr></table></figure>
<p>docker building:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">"registry.zerofinance.net/xpayappimage/kafka:3.3.2"</span> .</span><br><span class="line"><span class="comment">#docker login registry.zerofinance.net</span></span><br><span class="line">docker push <span class="string">"registry.zerofinance.net/xpayappimage/kafka:3.3.2"</span></span><br></pre></td></tr></table></figure>
<p>kafka-kraft.yml:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#部署 Service Headless，用于Kafka间相互通信</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka-svc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'9092'</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9092</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9092</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'9093'</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9093</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">#部署 Service，用于外部访问 Kafka</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment">#service.beta.kubernetes.io/alibaba-cloud-loadbalancer-address-type: "intranet"</span></span><br><span class="line">    <span class="comment">#service.beta.kubernetes.io/alibaba-cloud-loadbalancer-vswitch-id: "vsw-j6c8okcv03ah1uvu31tbm"</span></span><br><span class="line">    <span class="attr">service.beta.kubernetes.io/alibaba-cloud-loadbalancer-id:</span> <span class="string">"lb-3nsgew8gt6lzmtzc0vn93"</span></span><br><span class="line">    <span class="attr">service.beta.kubernetes.io/alibaba-cloud-loadbalancer-force-override-listeners:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka-broker</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'9092'</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9092</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9092</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">"kafka"</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">kafka-svc</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">"OrderedReady"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">"RollingUpdate"</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">"kafka"</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment">#securityContext:</span></span><br><span class="line">      <span class="comment">#  fsGroup: 1001</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">xpay-env:</span> <span class="string">logs</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">"xpay-env"</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">"Equal"</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">"logs"</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">"NoSchedule"</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kafka</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">"registry.zerofinance.net/xpayappimage/kafka:3.3.2"</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">"Always"</span></span><br><span class="line">        <span class="comment">#securityContext:</span></span><br><span class="line">        <span class="comment">#  runAsNonRoot: true</span></span><br><span class="line">        <span class="comment">#  runAsUser: 1001</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REPLICAS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">'3'</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVICE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">kafka-svc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SHARE_DIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/mnt/kafka</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CLUSTER_ID</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">LelM2dIFQkiUFvXCEcqRWA</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_REPLICATION_FACTOR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">'3'</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEFAULT_MIN_INSYNC_REPLICAS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">'2'</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9092</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9093</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">9092</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">9092</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">6</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/mnt/kafka</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">"/data/data/kafka-k8s"</span></span><br></pre></td></tr></table></figure>
<p>kafka-ui.yml:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka-ui</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka-ui</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kafka</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="comment">#nodePort: 30900</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka-ui</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka-ui</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka-ui</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">kafka-ui</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kafka-ui</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kafka-ui</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">provectuslabs/kafka-ui:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kafka-ui</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DYNAMIC_CONFIG_ENABLED</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">kafka-ui</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/info</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">kafka-ui</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka-ui</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span> <span class="string">[]</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">kafka-ui-test.zerofinance.net</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">kafka-ui</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p>Test:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl -n zero-logs run kafka-client --rm -ti --image bitnami/kafka:3.1.0 -- bash</span><br><span class="line">kafka-topics.sh --create --bootstrap-server kafka-svc:9092 --replication-factor 2 --partitions 3 --topic <span class="built_in">test</span></span><br><span class="line">kafka-topics.sh --bootstrap-server kafka-svc:9092 --list</span><br><span class="line">kafka-console-producer.sh --broker-list kafka-svc:9092 --topic <span class="built_in">test</span></span><br><span class="line">kafka-console-consumer.sh --bootstrap-server kafka-svc:9092 --topic <span class="built_in">test</span> --from-beginning</span><br><span class="line"></span><br><span class="line">kafka-topics.sh --create --bootstrap-server kafka-broker-test.zerofinance.net:9092 --replication-factor 2 --partitions 3 --topic <span class="built_in">test</span></span><br><span class="line">kafka-topics.sh --bootstrap-server kafka-broker-test.zerofinance.net:9092 --list</span><br><span class="line">kafka-console-producer.sh --broker-list kafka-broker-test.zerofinance.net:9092 --topic <span class="built_in">test</span></span><br><span class="line">kafka-console-consumer.sh --bootstrap-server kafka-broker-test.zerofinance.net:9092 --topic <span class="built_in">test</span> --from-beginning</span><br></pre></td></tr></table></figure>
<h2 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h2><blockquote>
<p><a href="https://www.qikqiak.com/k8strain/controller/statefulset/" target="_blank" rel="noopener">https://www.qikqiak.com/k8strain/controller/statefulset/</a><br><a href="https://www.jianshu.com/p/f0b0fc3d192f" target="_blank" rel="noopener">https://www.jianshu.com/p/f0b0fc3d192f</a><br><a href="https://itopic.org/kafka-in-k8s.html" target="_blank" rel="noopener">https://itopic.org/kafka-in-k8s.html</a><br><a href="https://itopic.org/zookeeper-in-k8s.html" target="_blank" rel="noopener">https://itopic.org/zookeeper-in-k8s.html</a></p>
</blockquote>
<p>Need to modify resource from: <a href="https://github.com/31z4/zookeeper-docker/tree/master/3.8.1" target="_blank" rel="noopener">https://github.com/31z4/zookeeper-docker/tree/master/3.8.1</a></p>
<p><img src="/images/Loki-Log-System/zookeeper01.png" alt="zookeeper01.png"></p>
<p><img src="/images/Loki-Log-System/zookeeper02.png" alt="zookeeper02.png"></p>
<p>docker-entrypoint.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">ZOO_MY_ID=$(($(hostname | sed s/.*-//) + 1))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow the container to be started with `--user`</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">'zkServer.sh'</span> &amp;&amp; <span class="string">"<span class="variable">$(id -u)</span>"</span> = <span class="string">'0'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    chown -R zookeeper <span class="string">"<span class="variable">$ZOO_DATA_DIR</span>"</span> <span class="string">"<span class="variable">$ZOO_DATA_LOG_DIR</span>"</span> <span class="string">"<span class="variable">$ZOO_LOG_DIR</span>"</span></span><br><span class="line">    <span class="built_in">exec</span> gosu zookeeper <span class="string">"<span class="variable">$0</span>"</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$ZOO_DATA_DIR</span>/<span class="variable">$ZOO_MY_ID</span> <span class="variable">$ZOO_DATA_LOG_DIR</span>/<span class="variable">$ZOO_MY_ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate the config only if it doesn't exist</span></span><br><span class="line"><span class="keyword">if</span> [[ ! -f <span class="string">"<span class="variable">$ZOO_CONF_DIR</span>/zoo.cfg"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    CONFIG=<span class="string">"<span class="variable">$ZOO_CONF_DIR</span>/zoo.cfg"</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"dataDir=<span class="variable">$ZOO_DATA_DIR</span>/<span class="variable">$ZOO_MY_ID</span>"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"dataLogDir=<span class="variable">$ZOO_DATA_LOG_DIR</span>/<span class="variable">$ZOO_MY_ID</span>"</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"tickTime=<span class="variable">$ZOO_TICK_TIME</span>"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"initLimit=<span class="variable">$ZOO_INIT_LIMIT</span>"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"syncLimit=<span class="variable">$ZOO_SYNC_LIMIT</span>"</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"autopurge.snapRetainCount=<span class="variable">$ZOO_AUTOPURGE_SNAPRETAINCOUNT</span>"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"autopurge.purgeInterval=<span class="variable">$ZOO_AUTOPURGE_PURGEINTERVAL</span>"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"maxClientCnxns=<span class="variable">$ZOO_MAX_CLIENT_CNXNS</span>"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"standaloneEnabled=<span class="variable">$ZOO_STANDALONE_ENABLED</span>"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"admin.enableServer=<span class="variable">$ZOO_ADMINSERVER_ENABLED</span>"</span></span><br><span class="line">    &#125; &gt;&gt; <span class="string">"<span class="variable">$CONFIG</span>"</span></span><br><span class="line">    <span class="keyword">if</span> [[ -z <span class="variable">$ZOO_SERVERS</span> ]]; <span class="keyword">then</span></span><br><span class="line">      ZOO_SERVERS=<span class="string">"server.1=localhost:2888:3888;2181"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> server <span class="keyword">in</span> <span class="variable">$ZOO_SERVERS</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$server</span>"</span> &gt;&gt; <span class="string">"<span class="variable">$CONFIG</span>"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="variable">$ZOO_4LW_COMMANDS_WHITELIST</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"4lw.commands.whitelist=<span class="variable">$ZOO_4LW_COMMANDS_WHITELIST</span>"</span> &gt;&gt; <span class="string">"<span class="variable">$CONFIG</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> cfg_extra_entry <span class="keyword">in</span> <span class="variable">$ZOO_CFG_EXTRA</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$cfg_extra_entry</span>"</span> &gt;&gt; <span class="string">"<span class="variable">$CONFIG</span>"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write myid only if it doesn't exist</span></span><br><span class="line"><span class="keyword">if</span> [[ ! -f <span class="string">"<span class="variable">$ZOO_DATA_DIR</span>/<span class="variable">$ZOO_MY_ID</span>/myid"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;ZOO_MY_ID:-1&#125;</span>"</span> &gt; <span class="string">"<span class="variable">$ZOO_DATA_DIR</span>/<span class="variable">$ZOO_MY_ID</span>/myid"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure>
<p>builds images:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">"registry.zerofinance.net/xpayappimage/zookeeper:3.8.1"</span> .</span><br><span class="line">docker push registry.zerofinance.net/xpayappimage/zookeeper:3.8.1</span><br></pre></td></tr></table></figure>
<h2 id="Loki"><a href="#Loki" class="headerlink" title="Loki"></a>Loki</h2><p>What’s the Grafana Loki?</p>
<p>Loki is a log aggregation system designed to store and query logs from all your applications and infrastructure.</p>
<p>Documents located in: <a href="https://grafana.com/docs/loki/latest/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/</a></p>
<p>Configurations of loki k8s: <a href="/files/Loki-Log-System/loki-k8s.zip">loki-k8s.zip</a></p>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><p><a href="https://grafana.com/docs/loki/latest/fundamentals/overview/#overview" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/fundamentals/overview/#overview</a></p>
<p>There are losts of way to install Loki, here show it by docker. the other ways please refer to: <a href="https://grafana.com/docs/loki/latest/installation/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/installation/</a></p>
<h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h4><p>If you clients are distributed on individual machines, you can use docker:</p>
<p>Installing:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#loki</span></span><br><span class="line">mkdir -p /data/loki/data/ /works/conf/loki/</span><br><span class="line"><span class="comment">#Getting the loki id from the following command:</span></span><br><span class="line"><span class="comment">#docker exec loki id</span></span><br><span class="line"><span class="comment">#Like: uid=10001(loki) gid=10001(loki) groups=10001(loki)</span></span><br><span class="line">chown -R 10001.10001 /data/loki/data/ /works/conf/loki/</span><br><span class="line"><span class="comment">#Creating the container:</span></span><br><span class="line">docker run -d --name loki --restart=always \</span><br><span class="line">-v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">-v /data/loki/data:/loki/data \</span><br><span class="line">-v /works/conf/loki:/mnt/config \</span><br><span class="line">-p 3100:3100 -p 7946:7946 -p 9096:9096 grafana/loki:2.8.0 \</span><br><span class="line">-config.file=/mnt/config/loki-config.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#grafana</span></span><br><span class="line"><span class="comment"># docker run -d --name grafana \</span></span><br><span class="line"><span class="comment"># -v /etc/localtime:/etc/localtime:ro \</span></span><br><span class="line"><span class="comment"># -e "GF_SMTP_ENABLED=true" \</span></span><br><span class="line"><span class="comment"># -e "GF_SMTP_HOST=smtp.example.com" \</span></span><br><span class="line"><span class="comment"># -e "GF_SMTP_USER=myuser" \</span></span><br><span class="line"><span class="comment"># -e "GF_SMTP_PASSWORD=mysecret" \</span></span><br><span class="line"><span class="comment"># -p 3000:3000 grafana/grafana:latest</span></span><br><span class="line">chown -R 10001.10001 /data/grafana/</span><br><span class="line">docker run -d --name grafana9 --restart=always \</span><br><span class="line">-v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">-v /data/grafana/:/var/lib/grafana \</span><br><span class="line">-v /data/grafana/grafana.ini:/etc/grafana/grafana.ini \</span><br><span class="line">--user 10001:10001 \</span><br><span class="line">-p 3000:3000 grafana/grafana-oss:9.3.1</span><br><span class="line"></span><br><span class="line"><span class="comment">#promtail</span></span><br><span class="line">docker run -d --name promtail --restart=always \</span><br><span class="line">-v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">-v /works/conf/promtail:/mnt/config \</span><br><span class="line">-v /works/<span class="built_in">log</span>:/works/<span class="built_in">log</span> \</span><br><span class="line">grafana/promtail:2.8.0 \</span><br><span class="line">-config.file=/mnt/config/promtail-config.yaml \</span><br><span class="line">-client.external-labels=hostname=<span class="variable">$&#123;HOSTNAME&#125;</span></span><br><span class="line"></span><br><span class="line">docker run -d --name promtail-monitor --restart=always \</span><br><span class="line">-v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">-v /works/conf/promtail/biz:/mnt/config \</span><br><span class="line">grafana/promtail:2.8.0 \</span><br><span class="line">-config.file=/mnt/config/promtail-config.yaml \</span><br><span class="line">-client.external-labels=hostname=<span class="variable">$&#123;HOSTNAME&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#fluent-bit</span></span><br><span class="line">docker run  --name fluent-bit --restart=always --network host -d \</span><br><span class="line">-v /data/fluent-bit/:/fluent-bit/etc \</span><br><span class="line">-v /works/<span class="built_in">log</span>:/works/<span class="built_in">log</span> \</span><br><span class="line">fluent/fluent-bit:2.0.8</span><br><span class="line"></span><br><span class="line"><span class="comment">#kafka</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"><span class="comment">#Test</span></span><br><span class="line">docker <span class="built_in">exec</span> -it kafka-kafka9094-1 sh</span><br><span class="line">运行消费者,进行消息的监听</span><br><span class="line">kafka-console-consumer.sh --bootstrap-server 192.168.102.82:9092 --topic account --from-beginning</span><br><span class="line"><span class="comment">#docker exec -it kafka_kafka9094_1 kafka-console-consumer.sh --bootstrap-server 192.168.101.82:9092 --topic dev --from-beginning</span></span><br><span class="line"><span class="comment">#docker exec -it kafka_kafka9094_1 kafka-topics.sh --create --bootstrap-server 192.168.101.82:9092 --replication-factor 1 --partitions 3 --topic sandbox</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it kafka-kafka9094-1 sh</span><br><span class="line">打开一个新的ssh窗口,同样进入kafka的容器中,执行下面这条命令生产消息</span><br><span class="line">kafka-console-producer.sh --broker-list 192.168.102.82:9092 --topic account</span><br><span class="line"></span><br><span class="line"><span class="comment">#alertmanager</span></span><br><span class="line">mkdir -p /data/alertmanager/</span><br><span class="line">chown -R 65534:65534 /data/alertmanager/</span><br><span class="line"></span><br><span class="line">docker run -d --name alertmanager --restart=always \</span><br><span class="line">-v /data/alertmanager:/etc/alertmanager \</span><br><span class="line">-p 9093:9093 prom/alertmanager:v0.24.0 \</span><br><span class="line">--config.file=/etc/alertmanager/alertmanager-config.yaml \</span><br><span class="line">--web.external-url=http://192.168.80.98:9093 \</span><br><span class="line">--cluster.advertise-address=0.0.0.0:9093 \</span><br><span class="line">--log.level=debug</span><br></pre></td></tr></table></figure>
<p>reload alertmanager: curl -XPOST <a href="http://am-test.zerofinance.net/-/reload" target="_blank" rel="noopener">http://am-test.zerofinance.net/-/reload</a></p>
<p>Cluster Installation:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Loki(multiple machines):</span></span><br><span class="line">mkdir -p /data/loki/data/ /works/conf/loki/</span><br><span class="line">curl -O -L <span class="string">"https://github.com/grafana/loki/releases/download/v2.8.0/loki-linux-amd64.zip"</span></span><br><span class="line"><span class="comment"># extract the binary</span></span><br><span class="line">unzip <span class="string">"loki-linux-amd64.zip"</span></span><br><span class="line"><span class="comment"># make sure it is executable</span></span><br><span class="line">chmod a+x <span class="string">"loki-linux-amd64"</span></span><br><span class="line">./loki-linux-amd64 -config.file=loki-config.yaml</span><br><span class="line"></span><br><span class="line">loki-config.yaml:</span><br><span class="line"></span><br><span class="line">auth_enabled: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  log_level: info</span><br><span class="line">  http_listen_port: 3100</span><br><span class="line">  grpc_listen_port: 9096</span><br><span class="line">  grpc_server_max_recv_msg_size: 1572864000</span><br><span class="line">  grpc_server_max_send_msg_size: 1572864000</span><br><span class="line"></span><br><span class="line">memberlist:</span><br><span class="line">  join_members: [<span class="string">"192.168.101.82"</span>,<span class="string">"192.168.80.196"</span>]</span><br><span class="line">  dead_node_reclaim_time: 30s</span><br><span class="line">  gossip_to_dead_nodes_time: 15s</span><br><span class="line">  left_ingesters_timeout: 30s</span><br><span class="line">  bind_addr: [<span class="string">'0.0.0.0'</span>]</span><br><span class="line">  bind_port: 7946</span><br><span class="line">  gossip_interval: 2s</span><br><span class="line"></span><br><span class="line"><span class="comment">#https://grafana.com/blog/2021/02/16/the-essential-config-settings-you-should-use-so-you-wont-drop-logs-in-loki/</span></span><br><span class="line"><span class="comment">#https://mpolinowski.github.io/docs/DevOps/Provisioning/2021-04-07--loki-prometheus-grafana/2021-04-07/</span></span><br><span class="line">ingester:</span><br><span class="line">  lifecycler:</span><br><span class="line">    join_after: 10s</span><br><span class="line">    observe_period: 5s</span><br><span class="line">    ring:</span><br><span class="line">      replication_factor: 2</span><br><span class="line">      kvstore:</span><br><span class="line">        store: memberlist</span><br><span class="line">    <span class="comment"># Duration to sleep before exiting to ensure metrics are scraped</span></span><br><span class="line">    <span class="comment">#final_sleep: 0s</span></span><br><span class="line">  wal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    dir: /loki/data/wal</span><br><span class="line">  <span class="comment"># All chunks will be flushed when they hit this age, default is 1h</span></span><br><span class="line">  max_chunk_age: 1h</span><br><span class="line">  <span class="comment"># Any chunk not receiving new logs in this time will be flushed</span></span><br><span class="line">  chunk_idle_period: 1h</span><br><span class="line">  <span class="comment"># Must be greater than index read cache TTL if using an index cache (Default index read cache TTL is 5m)</span></span><br><span class="line">  chunk_retain_period: 30s</span><br><span class="line">  chunk_encoding: snappy</span><br><span class="line">  <span class="comment"># Loki will attempt to build chunks up to 1.5MB, flushing first if chunk_idle_period or max_chunk_age is reached first</span></span><br><span class="line">  chunk_target_size: 1572864</span><br><span class="line"></span><br><span class="line">schema_config:</span><br><span class="line">  configs:</span><br><span class="line">    - from: 2023-04-01</span><br><span class="line">      object_store: aws</span><br><span class="line">      schema: v11</span><br><span class="line">      store: boltdb-shipper</span><br><span class="line">      index:</span><br><span class="line">        period: 24h</span><br><span class="line">        prefix: index_</span><br><span class="line"></span><br><span class="line">storage_config:</span><br><span class="line">  boltdb_shipper:</span><br><span class="line">    active_index_directory: /loki/data/boltdb-shipper-active</span><br><span class="line">    cache_location: /loki/data/boltdb-shipper-cache</span><br><span class="line">    <span class="comment"># Can be increased for faster performance over longer query periods, uses more disk space</span></span><br><span class="line">    cache_ttl: 24h</span><br><span class="line">    shared_store: s3</span><br><span class="line">  aws:</span><br><span class="line">    s3forcepathstyle: <span class="literal">false</span></span><br><span class="line">    bucketnames: loki-files</span><br><span class="line">    endpoint: https://oss-cn-hongkong.aliyuncs.com</span><br><span class="line">    access_key_id: LTA11111111111</span><br><span class="line">    secret_access_key: unseba111111111111111111</span><br><span class="line">    insecure: <span class="literal">true</span></span><br><span class="line">  index_queries_cache_config:</span><br><span class="line">    redis:</span><br><span class="line">      endpoint: r-111111111.redis.rds.aliyuncs.com:6379</span><br><span class="line">      password: 111111111</span><br><span class="line">      expiration: 1h</span><br><span class="line">    </span><br><span class="line">chunk_store_config:</span><br><span class="line">  chunk_cache_config:</span><br><span class="line">    redis:</span><br><span class="line">      endpoint: r-111111111.redis.rds.aliyuncs.com:6379</span><br><span class="line">      password: 111111111</span><br><span class="line">      expiration: 1h    </span><br><span class="line">  write_dedupe_cache_config:</span><br><span class="line">    redis:</span><br><span class="line">      endpoint: r-111111111.redis.rds.aliyuncs.com:6379</span><br><span class="line">      password: 111111111</span><br><span class="line">      expiration: 1h</span><br><span class="line"></span><br><span class="line">query_range:</span><br><span class="line">  results_cache:</span><br><span class="line">    cache:</span><br><span class="line">      redis:</span><br><span class="line">        endpoint: r-111111111.redis.rds.aliyuncs.com:6379</span><br><span class="line">        password: 111111111</span><br><span class="line">        expiration: 1h</span><br><span class="line">  cache_results: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">compactor:</span><br><span class="line">  working_directory: /loki/data/boltdb-shipper-compactor</span><br><span class="line">  shared_store: s3</span><br><span class="line"></span><br><span class="line">limits_config:</span><br><span class="line">  ingestion_rate_mb: 2</span><br><span class="line">  ingestion_burst_size_mb: 4</span><br><span class="line">  max_streams_per_user: 0</span><br><span class="line">  max_global_streams_per_user: 0</span><br><span class="line">  enforce_metric_name: <span class="literal">false</span></span><br><span class="line">  reject_old_samples: <span class="literal">true</span></span><br><span class="line">  reject_old_samples_max_age: 168h</span><br><span class="line"></span><br><span class="line">table_manager:</span><br><span class="line">  retention_deletes_enabled: <span class="literal">true</span></span><br><span class="line">  retention_period: 168h</span><br><span class="line"></span><br><span class="line"><span class="comment">#https://grafana.com/docs/loki/latest/configuration/</span></span><br><span class="line">ruler:</span><br><span class="line">  storage:</span><br><span class="line">    <span class="built_in">type</span>: s3</span><br><span class="line">    s3:</span><br><span class="line">      s3forcepathstyle: <span class="literal">false</span></span><br><span class="line">      bucketnames: loki-files</span><br><span class="line">      endpoint: https://oss-cn-hongkong.aliyuncs.com</span><br><span class="line">      access_key_id: LTA11111111111</span><br><span class="line">      secret_access_key: unseba111111111111111111</span><br><span class="line">      insecure: <span class="literal">true</span></span><br><span class="line">  <span class="comment">#rule_path: /loki/data/rules-temp</span></span><br><span class="line">  alertmanager_url: http://192.168.101.82:9093</span><br><span class="line">  <span class="comment"># How frequently to evaluate rules.</span></span><br><span class="line">  evaluation_interval: 5s</span><br><span class="line">  <span class="comment"># How frequently to poll for rule changes.</span></span><br><span class="line">  poll_interval: 5s</span><br><span class="line">  ring:</span><br><span class="line">    kvstore:</span><br><span class="line">      store: memberlist</span><br><span class="line">  enable_api: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>Uninstalling:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#loki</span></span><br><span class="line">docker rm -vf loki</span><br><span class="line">/bin/rm -fr /data/loki/data/*</span><br><span class="line">mkdir -p /data/loki/data/</span><br><span class="line"><span class="comment">#docker exec loki id</span></span><br><span class="line"><span class="comment">#uid=10001(loki) gid=10001(loki) groups=10001(loki)</span></span><br><span class="line">chown -R 10001.10001 /data/loki/data/</span><br><span class="line"></span><br><span class="line"><span class="comment">#promtail</span></span><br><span class="line">docker rm -vf promtail</span><br><span class="line"></span><br><span class="line"><span class="comment">#grafana</span></span><br><span class="line"><span class="comment">#docker rm -vf grafana</span></span><br></pre></td></tr></table></figure>
<p>Configuration:</p>
<p>loki-config.yaml:</p>
<p>For local file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auth_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">error</span></span><br><span class="line">  <span class="attr">http_listen_port:</span> <span class="number">3100</span></span><br><span class="line">  <span class="attr">grpc_listen_port:</span> <span class="number">9096</span></span><br><span class="line">  <span class="attr">grpc_server_max_recv_msg_size:</span> <span class="number">1572864000</span></span><br><span class="line">  <span class="attr">grpc_server_max_send_msg_size:</span> <span class="number">1572864000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingester:</span></span><br><span class="line">  <span class="attr">wal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">dir:</span> <span class="string">/loki/data/wal</span></span><br><span class="line">    <span class="attr">replay_memory_ceiling:</span> <span class="string">10G</span></span><br><span class="line">  <span class="attr">lifecycler:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">ring:</span></span><br><span class="line">      <span class="attr">kvstore:</span></span><br><span class="line">        <span class="attr">store:</span> <span class="string">inmemory</span></span><br><span class="line">      <span class="attr">replication_factor:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">heartbeat_timeout:</span> <span class="string">10m</span></span><br><span class="line">    <span class="attr">final_sleep:</span> <span class="string">0s</span></span><br><span class="line">  <span class="attr">chunk_idle_period:</span> <span class="string">1h</span></span><br><span class="line">  <span class="attr">max_chunk_age:</span> <span class="string">2h</span></span><br><span class="line">  <span class="attr">chunk_retain_period:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">chunk_target_size:</span> <span class="number">1572864</span></span><br><span class="line"></span><br><span class="line"><span class="attr">schema_config:</span></span><br><span class="line">  <span class="attr">configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span> <span class="number">2023</span><span class="number">-04</span><span class="number">-01</span></span><br><span class="line">      <span class="attr">store:</span> <span class="string">boltdb-shipper</span></span><br><span class="line">      <span class="attr">object_store:</span> <span class="string">filesystem</span></span><br><span class="line">      <span class="attr">schema:</span> <span class="string">v11</span></span><br><span class="line">      <span class="attr">index:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">index_</span></span><br><span class="line">        <span class="attr">period:</span> <span class="string">24h</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">storage_config:</span></span><br><span class="line">  <span class="attr">boltdb_shipper:</span></span><br><span class="line">    <span class="attr">active_index_directory:</span> <span class="string">/loki/data/index</span></span><br><span class="line">    <span class="attr">cache_location:</span> <span class="string">/loki/data/boltdb-shipper-cache</span></span><br><span class="line">    <span class="attr">cache_ttl:</span> <span class="string">24h</span></span><br><span class="line">    <span class="attr">shared_store:</span> <span class="string">filesystem</span></span><br><span class="line">  <span class="attr">filesystem:</span></span><br><span class="line">    <span class="attr">directory:</span> <span class="string">/loki/data/chunks</span></span><br><span class="line"></span><br><span class="line"><span class="attr">compactor:</span></span><br><span class="line">  <span class="attr">working_directory:</span> <span class="string">/loki/data/boltdb-shipper-compactor</span></span><br><span class="line">  <span class="attr">shared_store:</span> <span class="string">filesystem</span></span><br><span class="line"></span><br><span class="line"><span class="attr">limits_config:</span></span><br><span class="line">  <span class="attr">ingestion_rate_mb:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">ingestion_burst_size_mb:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">max_streams_per_user:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">max_global_streams_per_user:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">enforce_metric_name:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">reject_old_samples:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">reject_old_samples_max_age:</span> <span class="string">168h</span></span><br><span class="line"></span><br><span class="line"><span class="attr">table_manager:</span></span><br><span class="line">  <span class="attr">retention_deletes_enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">retention_period:</span> <span class="string">168h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#https://grafana.com/docs/loki/latest/configuration/</span></span><br><span class="line"><span class="attr">ruler:</span></span><br><span class="line">  <span class="attr">storage:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line">    <span class="attr">local:</span></span><br><span class="line">      <span class="attr">directory:</span> <span class="string">/mnt/config/rules</span></span><br><span class="line">  <span class="attr">rule_path:</span> <span class="string">/loki/data/rules-temp</span></span><br><span class="line">  <span class="attr">alertmanager_url:</span> <span class="string">http://192.168.101.82:9093</span></span><br><span class="line">  <span class="comment"># How frequently to evaluate rules.</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">5s</span></span><br><span class="line">  <span class="comment"># How frequently to poll for rule changes.</span></span><br><span class="line">  <span class="attr">poll_interval:</span> <span class="string">5s</span></span><br><span class="line">  <span class="attr">ring:</span></span><br><span class="line">    <span class="attr">kvstore:</span></span><br><span class="line">      <span class="attr">store:</span> <span class="string">inmemory</span></span><br><span class="line">  <span class="attr">enable_api:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>For Aliyun OSS:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auth_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">error</span></span><br><span class="line">  <span class="attr">http_listen_port:</span> <span class="number">3100</span></span><br><span class="line">  <span class="attr">grpc_listen_port:</span> <span class="number">9096</span></span><br><span class="line">  <span class="attr">grpc_server_max_recv_msg_size:</span> <span class="number">1572864000</span></span><br><span class="line">  <span class="attr">grpc_server_max_send_msg_size:</span> <span class="number">1572864000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingester:</span></span><br><span class="line">  <span class="attr">wal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">dir:</span> <span class="string">/loki/data/wal</span></span><br><span class="line">    <span class="attr">replay_memory_ceiling:</span> <span class="string">10G</span></span><br><span class="line">  <span class="attr">lifecycler:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">ring:</span></span><br><span class="line">      <span class="attr">kvstore:</span></span><br><span class="line">        <span class="attr">store:</span> <span class="string">inmemory</span></span><br><span class="line">      <span class="attr">replication_factor:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">heartbeat_timeout:</span> <span class="string">10m</span></span><br><span class="line">    <span class="attr">final_sleep:</span> <span class="string">0s</span></span><br><span class="line">  <span class="comment"># chunk_idle_period: 1h</span></span><br><span class="line">  <span class="comment"># max_chunk_age: 2h</span></span><br><span class="line">  <span class="comment"># chunk_retain_period: 30s</span></span><br><span class="line">  <span class="comment"># chunk_target_size: 1572864</span></span><br><span class="line"></span><br><span class="line"><span class="attr">schema_config:</span></span><br><span class="line">  <span class="attr">configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span> <span class="number">2022</span><span class="number">-01</span><span class="number">-01</span></span><br><span class="line">      <span class="attr">index:</span></span><br><span class="line">        <span class="attr">period:</span> <span class="string">24h</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">index_</span></span><br><span class="line">      <span class="attr">object_store:</span> <span class="string">aws</span></span><br><span class="line">      <span class="attr">schema:</span> <span class="string">v11</span></span><br><span class="line">      <span class="attr">store:</span> <span class="string">boltdb-shipper</span></span><br><span class="line"></span><br><span class="line"><span class="attr">storage_config:</span></span><br><span class="line">  <span class="attr">boltdb_shipper:</span></span><br><span class="line">    <span class="attr">active_index_directory:</span> <span class="string">/loki/data/boltdb-shipper-active</span></span><br><span class="line">    <span class="attr">cache_location:</span> <span class="string">/loki/data/boltdb-shipper-cache</span></span><br><span class="line">    <span class="attr">cache_ttl:</span> <span class="string">24h</span></span><br><span class="line">    <span class="attr">shared_store:</span> <span class="string">s3</span></span><br><span class="line">  <span class="attr">aws:</span></span><br><span class="line">    <span class="attr">s3forcepathstyle:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">bucketnames:</span> <span class="string">loki-files</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">https://oss-cn-shenzhen.aliyuncs.com</span></span><br><span class="line">    <span class="attr">access_key_id:</span> <span class="string">xxxx</span></span><br><span class="line">    <span class="attr">secret_access_key:</span> <span class="string">xxxx</span></span><br><span class="line">    <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">analytics:</span></span><br><span class="line">  <span class="attr">reporting_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">compactor:</span></span><br><span class="line">  <span class="attr">working_directory:</span> <span class="string">/loki/data/boltdb-shipper-compactor</span></span><br><span class="line">  <span class="attr">shared_store:</span> <span class="string">s3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># table_manager:</span></span><br><span class="line"><span class="comment">#   retention_deletes_enabled: true</span></span><br><span class="line"><span class="comment">#   retention_period: 336h</span></span><br><span class="line"></span><br><span class="line"><span class="attr">limits_config:</span></span><br><span class="line">  <span class="attr">ingestion_rate_mb:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">ingestion_burst_size_mb:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">max_streams_per_user:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">max_global_streams_per_user:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">enforce_metric_name:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">reject_old_samples:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">reject_old_samples_max_age:</span> <span class="string">168h</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ruler:</span></span><br><span class="line">  <span class="attr">storage:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line">    <span class="attr">local:</span></span><br><span class="line">      <span class="attr">directory:</span> <span class="string">/mnt/config/rules</span></span><br><span class="line">  <span class="attr">rule_path:</span> <span class="string">/loki/data/rules-temp</span></span><br><span class="line">  <span class="attr">alertmanager_url:</span> <span class="string">http://192.168.102.82:9093</span></span><br><span class="line">  <span class="attr">ring:</span></span><br><span class="line">    <span class="attr">kvstore:</span></span><br><span class="line">      <span class="attr">store:</span> <span class="string">inmemory</span></span><br><span class="line">  <span class="attr">enable_api:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>promtail-config.yaml:</p>
<p>For log files:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">http_listen_port:</span> <span class="number">9080</span></span><br><span class="line">  <span class="attr">grpc_listen_port:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">positions:</span></span><br><span class="line">  <span class="attr">filename:</span> <span class="string">/tmp/positions.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">clients:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://192.168.80.196:3100/loki/api/v1/push</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="comment"># - job_name: service_log</span></span><br><span class="line"><span class="comment">#   file_sd_configs:</span></span><br><span class="line"><span class="comment">#     - files:</span></span><br><span class="line"><span class="comment">#       - ./config/*.yaml #从config目录下加载配置文件</span></span><br><span class="line"><span class="comment">#       refresh_interval: 1m</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">company-job</span> </span><br><span class="line">  <span class="attr">pipeline_stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">      <span class="attr">selector:</span> <span class="string">'&#123;belongs="company", filename=~".*(?:error|tmlog).*"&#125;'</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">      <span class="attr">drop_counter_reason:</span> <span class="string">promtail_noisy_error</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">      <span class="attr">selector:</span> <span class="string">'&#123;belongs="company"&#125;'</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">          <span class="attr">source:</span> <span class="string">filename</span></span><br><span class="line">          <span class="attr">expression:</span> <span class="string">"^/works/log/(?P&lt;org&gt;.+?)/(?P&lt;env&gt;.+?)/(?P&lt;app_name&gt;.+?)/.+\\.log$"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">org:</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="attr">app_name:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">      <span class="attr">selector:</span> <span class="string">'&#123;org=~".+"&#125;'</span></span><br><span class="line">      <span class="attr">stages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">multiline:</span></span><br><span class="line">          <span class="attr">firstline:</span> <span class="string">'^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125; \d&#123;1,2&#125;:\d&#123;2&#125;:\d&#123;2&#125;'</span></span><br><span class="line">          <span class="attr">max_lines:</span> <span class="number">500</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">          <span class="attr">expression:</span> <span class="string">"^(?P&lt;time&gt;\\d&#123;4&#125;\\-\\d&#123;2&#125;\\-\\d&#123;2&#125; \\d&#123;1,2&#125;\\:\\d&#123;2&#125;\\:\\d&#123;2&#125;).*"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">timestamp:</span></span><br><span class="line">          <span class="attr">source:</span> <span class="string">time</span></span><br><span class="line">          <span class="attr">format:</span> <span class="string">'2006-01-02 15:04:05'</span></span><br><span class="line">          <span class="attr">location:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">belongs:</span> <span class="string">company</span></span><br><span class="line">      <span class="attr">__path__:</span> <span class="string">/works/log/**/*.log</span></span><br></pre></td></tr></table></figure>
<p>Recoverying local files automatically:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service_log</span></span><br><span class="line">  <span class="attr">file_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/*.yaml</span> <span class="comment">#从config目录下加载配置文件</span></span><br><span class="line">      <span class="attr">refresh_interval:</span> <span class="string">1m</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">company-job</span> </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>config/pipeline_stages.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">belongs:</span> <span class="string">company</span></span><br><span class="line">    <span class="attr">__path__:</span> <span class="string">/works/log/**/*.log</span></span><br><span class="line">    <span class="comment">#env: &#123;&#123;ENV&#125;&#125;</span></span><br><span class="line">    <span class="comment">#hostname: &#123;&#123;BINDIP&#125;&#125;</span></span><br><span class="line">    <span class="comment"># service_name: var-log-messages</span></span><br><span class="line">    <span class="comment"># log_type: var-log-messages</span></span><br></pre></td></tr></table></figure>
<p>For Kafka:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">http_listen_port:</span> <span class="number">9080</span></span><br><span class="line">  <span class="attr">grpc_listen_port:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">positions:</span></span><br><span class="line">  <span class="attr">filename:</span> <span class="string">/tmp/positions.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">clients:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://192.168.101.82:3100/loki/api/v1/push</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">kafka</span></span><br><span class="line">    <span class="comment"># file_sd_configs:</span></span><br><span class="line">    <span class="comment">#   - files:</span></span><br><span class="line">    <span class="comment">#     - /mnt/config/config/*.yaml</span></span><br><span class="line">    <span class="comment">#     refresh_interval: 1m</span></span><br><span class="line">    <span class="attr">kafka:</span></span><br><span class="line">      <span class="attr">brokers:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.98</span><span class="string">:9092</span></span><br><span class="line">      <span class="attr">topics:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">uat</span></span><br><span class="line">      <span class="attr">group_id:</span> <span class="string">promtail_davetest</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">job:</span> <span class="string">kafka</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_topic</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">topic</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_partition</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">partition</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_group_id</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">group</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_message_key</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">message_key</span></span><br><span class="line">    <span class="attr">pipeline_stages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kafka"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">json:</span></span><br><span class="line">              <span class="attr">expressions:</span></span><br><span class="line">                <span class="attr">log:</span> <span class="string">log</span></span><br><span class="line">                <span class="attr">filename:</span> <span class="string">filename</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">filename:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kafka", filename=~".*(?:error|tmlog).*"&#125;'</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">          <span class="attr">drop_counter_reason:</span> <span class="string">promtail_noisy_error</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kafka"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">filename</span></span><br><span class="line">              <span class="attr">expression:</span> <span class="string">"^/works/log/(?P&lt;org&gt;.+?)/(?P&lt;env&gt;.+?)/(?P&lt;app_name&gt;.+?)/.+\\.log$"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">org:</span></span><br><span class="line">              <span class="attr">env:</span></span><br><span class="line">              <span class="attr">app_name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">output:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;org=~".+"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="comment">#- multiline:</span></span><br><span class="line">          <span class="comment">#  firstline: '^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125; \d&#123;1,2&#125;:\d&#123;2&#125;:\d&#123;2&#125;'</span></span><br><span class="line">          <span class="comment">#  max_lines: 500</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">              <span class="comment">#expression: "^(?P&lt;time&gt;\\d&#123;4&#125;\\-\\d&#123;2&#125;\\-\\d&#123;2&#125; \\d&#123;1,2&#125;\\:\\d&#123;2&#125;\\:\\d&#123;2&#125;).+?\\[bizKey=(?P&lt;biz_key&gt;.*?)\\,bizValue=(?P&lt;biz_value&gt;.*?)\\].*"</span></span><br><span class="line">              <span class="attr">expression:</span> <span class="string">"^(?P&lt;time&gt;\\d&#123;4&#125;\\-\\d&#123;2&#125;\\-\\d&#123;2&#125; \\d&#123;1,2&#125;\\:\\d&#123;2&#125;\\:\\d&#123;2&#125;).*"</span></span><br><span class="line">          <span class="comment">#- pack:</span></span><br><span class="line">          <span class="comment">#    labels:</span></span><br><span class="line">          <span class="comment">#      - time</span></span><br><span class="line">          <span class="comment">#      - biz_key</span></span><br><span class="line">          <span class="comment">#- labels:</span></span><br><span class="line">          <span class="comment">#    biz_key:</span></span><br><span class="line">          <span class="comment">#    biz_value:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">timestamp:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">times</span></span><br><span class="line">              <span class="attr">format:</span> <span class="string">'2006-01-02 15:04:05'</span></span><br><span class="line">              <span class="attr">location:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">kakfka_payinfo</span></span><br><span class="line">    <span class="comment"># file_sd_configs:</span></span><br><span class="line">    <span class="comment">#   - files:</span></span><br><span class="line">    <span class="comment">#     - /mnt/config/config/*.yaml</span></span><br><span class="line">    <span class="comment">#     refresh_interval: 1m</span></span><br><span class="line">    <span class="attr">kafka:</span></span><br><span class="line">      <span class="attr">brokers:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.98</span><span class="string">:9092</span></span><br><span class="line">      <span class="attr">topics:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">uat</span></span><br><span class="line">      <span class="attr">group_id:</span> <span class="string">promtail_payinfo_davetest</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">job:</span> <span class="string">kakfka_payinfo</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_topic</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">topic</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_partition</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">partition</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_group_id</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">group</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_message_key</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">message_key</span></span><br><span class="line">    <span class="attr">pipeline_stages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kakfka_payinfo"&#125; !~ ".*(PAYMENT_REFERENCE_LOG|CHECKOUT_PAYMENT_LOG).*"'</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">          <span class="attr">drop_counter_reason:</span> <span class="string">promtail_noisy_error</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kakfka_payinfo"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">json:</span></span><br><span class="line">              <span class="attr">expressions:</span></span><br><span class="line">                <span class="attr">log:</span> <span class="string">log</span></span><br><span class="line">                <span class="attr">filename:</span> <span class="string">filename</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">filename:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kakfka_payinfo"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">filename</span></span><br><span class="line">              <span class="attr">expression:</span> <span class="string">"^/works/log/(?P&lt;org&gt;.+?)/(?P&lt;env&gt;.+?)/(?P&lt;app_name&gt;.+?)/.+\\.log$"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">org:</span></span><br><span class="line">              <span class="attr">env:</span></span><br><span class="line">              <span class="attr">app_name:</span></span><br><span class="line">              <span class="attr">payinfo:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">output:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kakfka_payinfo", app_name="payment-server"&#125; |~ "PAYMENT_REFERENCE_LOG|CHECKOUT_PAYMENT_LOG"'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="comment">#- multiline:</span></span><br><span class="line">          <span class="comment">#    firstline: '^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125; \d&#123;1,2&#125;:\d&#123;2&#125;:\d&#123;2&#125;'</span></span><br><span class="line">          <span class="comment">#  max_lines: 500</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">              <span class="attr">expression:</span> <span class="string">"^(?P&lt;time&gt;\\d&#123;4&#125;\\-\\d&#123;2&#125;\\-\\d&#123;2&#125; \\d&#123;1,2&#125;\\:\\d&#123;2&#125;\\:\\d&#123;2&#125;).*"</span></span><br><span class="line">          <span class="comment"># - pack:</span></span><br><span class="line">          <span class="comment">#     labels:</span></span><br><span class="line">          <span class="comment">#       - time</span></span><br><span class="line">          <span class="comment"># - labels:</span></span><br><span class="line">          <span class="comment">#     time:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">timestamp:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">times</span></span><br><span class="line">              <span class="attr">format:</span> <span class="string">'2006-01-02 15:04:05'</span></span><br><span class="line">              <span class="attr">location:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">kafka_monitor</span></span><br><span class="line">    <span class="comment"># file_sd_configs:</span></span><br><span class="line">    <span class="comment">#   - files:</span></span><br><span class="line">    <span class="comment">#     - /mnt/config/config/*.yaml</span></span><br><span class="line">    <span class="comment">#     refresh_interval: 1m</span></span><br><span class="line">    <span class="attr">kafka:</span></span><br><span class="line">      <span class="attr">brokers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.80</span><span class="number">.98</span><span class="string">:9092</span></span><br><span class="line">      <span class="attr">topics:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">dev</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">uat</span></span><br><span class="line">      <span class="attr">group_id:</span> <span class="string">promtail_monitor_davetest</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">job:</span> <span class="string">kafka_monitor</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_topic</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">topic</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_partition</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">partition</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_group_id</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">group</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">__meta_kafka_message_key</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">message_key</span></span><br><span class="line">    <span class="attr">pipeline_stages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kafka_monitor"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">json:</span></span><br><span class="line">                <span class="attr">expressions:</span></span><br><span class="line">                  <span class="attr">log:</span> <span class="string">log</span></span><br><span class="line">                  <span class="attr">filename:</span> <span class="string">filename</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">                <span class="attr">filename:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kafka_monitor", filename=~".*(?:error|tmlog).*"&#125;'</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">          <span class="attr">drop_counter_reason:</span> <span class="string">promtail_noisy_error</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;job="kafka_monitor"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">                <span class="attr">source:</span> <span class="string">filename</span></span><br><span class="line">                <span class="attr">expression:</span> <span class="string">"^/works/log/(?P&lt;org&gt;.+?)/(?P&lt;env&gt;.+?)/(?P&lt;app_name&gt;.+?)/.+\\.log$"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">                <span class="attr">org:</span></span><br><span class="line">                <span class="attr">env:</span></span><br><span class="line">                <span class="attr">app_name:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">output:</span></span><br><span class="line">                <span class="attr">source:</span> <span class="string">log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;org=~".+"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">            <span class="comment">#- multiline:</span></span><br><span class="line">            <span class="comment">#  firstline: '^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125; \d&#123;1,2&#125;:\d&#123;2&#125;:\d&#123;2&#125;'</span></span><br><span class="line">            <span class="comment">#  max_lines: 500</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">                <span class="comment">#[bizGroup=default, bizKey=TRANSFER_MONEY_FAILED, bizDesc=交易异常-订单超时-转账, bizValue=&#123;"orderId":"orderNo1234567","time":"2023-04-07 12:40:37"&#125;]</span></span><br><span class="line">                <span class="attr">expression:</span> <span class="string">"^(?P&lt;time&gt;\\d&#123;4&#125;\\-\\d&#123;2&#125;\\-\\d&#123;2&#125; \\d&#123;1,2&#125;\\:\\d&#123;2&#125;\\:\\d&#123;2&#125;).+?\\[bizGroup=(?P&lt;biz_group&gt;.*?)\\,\\s*bizKey=(?P&lt;biz_key&gt;.*?)\\,\\s*bizDesc=(?P&lt;biz_desc&gt;.*?)\\,\\s*bizValue=(?P&lt;biz_value&gt;.*?)\\].*"</span></span><br><span class="line">            <span class="comment">#- pack:</span></span><br><span class="line">            <span class="comment">#    labels:</span></span><br><span class="line">            <span class="comment">#      - time</span></span><br><span class="line">            <span class="comment">#      - biz_key</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">                <span class="attr">biz_group:</span></span><br><span class="line">                <span class="attr">biz_key:</span></span><br><span class="line">                <span class="attr">biz_desc:</span></span><br><span class="line">                <span class="attr">biz_value:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">timestamp:</span></span><br><span class="line">                <span class="attr">source:</span> <span class="string">times</span></span><br><span class="line">                <span class="attr">format:</span> <span class="string">'2006-01-02 15:04:05'</span></span><br><span class="line">                <span class="attr">location:</span> <span class="string">Asia/Shanghai</span></span><br></pre></td></tr></table></figure>
<p>/etc/grafana/grafana.ini</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">domain</span> <span class="string">=</span> <span class="string">logs.company.net</span></span><br><span class="line"></span><br><span class="line"><span class="string">root_url</span> <span class="string">=</span> <span class="string">https://%(domain)s/</span></span><br><span class="line"></span><br><span class="line"><span class="string">[smtp]</span></span><br><span class="line"><span class="string">enabled</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">host</span> <span class="string">=</span> <span class="string">smtp.exmail.qq.com:465</span></span><br><span class="line"><span class="string">user</span> <span class="string">=</span> </span><br><span class="line"><span class="comment"># If the password contains # or ; you have to wrap it with triple quotes. Ex """</span></span><br><span class="line"><span class="string">password</span> <span class="string">=</span> </span><br><span class="line"><span class="string">;cert_file</span> <span class="string">=</span></span><br><span class="line"><span class="string">;;key_file</span> <span class="string">=</span></span><br><span class="line"><span class="string">;skip_verify</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">from_address</span> <span class="string">=</span> </span><br><span class="line"><span class="string">from_name</span> <span class="string">=</span> <span class="string">Grafana</span></span><br><span class="line"><span class="string">;#</span> <span class="string">EHLO</span> <span class="string">identity</span> <span class="string">in</span> <span class="string">SMTP</span> <span class="string">dialog</span> <span class="string">(defaults</span> <span class="string">to</span> <span class="string">instance_name)</span></span><br><span class="line"><span class="string">;;ehlo_identity</span> <span class="string">=</span> <span class="string">dashboard.example.com</span></span><br><span class="line"><span class="comment"># SMTP startTLS policy (defaults to 'OpportunisticStartTLS')</span></span><br><span class="line"><span class="string">startTLS_policy</span> <span class="string">=</span> <span class="string">StartTLS</span></span><br></pre></td></tr></table></figure>
<p>fluent-bit/fluent-bit.conf</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[SERVICE]</span></span><br><span class="line">    <span class="comment">#Parsers_File parser.conf # 解析文件位置</span></span><br><span class="line">    <span class="string">Flush</span>        <span class="number">5</span>           <span class="comment"># 5秒写入一次ES</span></span><br><span class="line">    <span class="string">Daemon</span>       <span class="string">Off</span></span><br><span class="line">    <span class="string">Log_Level</span>    <span class="string">warn</span></span><br><span class="line">    <span class="string">parsers_file</span> <span class="string">parsers_multiline.conf</span></span><br><span class="line"></span><br><span class="line"><span class="string">[INPUT]</span></span><br><span class="line">    <span class="string">Name</span>             <span class="string">tail</span></span><br><span class="line">    <span class="string">Tag</span>              <span class="string">dev</span></span><br><span class="line">    <span class="string">path_key</span>         <span class="string">filename</span></span><br><span class="line">    <span class="comment">#read_from_head   true</span></span><br><span class="line">    <span class="string">multiline.parser</span> <span class="string">multiline-regex</span></span><br><span class="line">    <span class="string">Exclude_Path</span>     <span class="string">/works/log/*/dev/**/*-error.log</span></span><br><span class="line">    <span class="string">Path</span>             <span class="string">/works/log/*/dev/**/*.log</span></span><br><span class="line">    <span class="string">Buffer_Chunk_Size</span> <span class="string">4096KB</span></span><br><span class="line">    <span class="string">Buffer_Max_Size</span>   <span class="string">10240KB</span></span><br><span class="line"></span><br><span class="line"><span class="string">[INPUT]</span></span><br><span class="line">    <span class="string">Name</span>             <span class="string">tail</span></span><br><span class="line">    <span class="string">Tag</span>              <span class="string">test</span></span><br><span class="line">    <span class="string">path_key</span>         <span class="string">filename</span></span><br><span class="line">    <span class="comment">#read_from_head   true</span></span><br><span class="line">    <span class="string">multiline.parser</span> <span class="string">multiline-regex</span></span><br><span class="line">    <span class="string">Exclude_Path</span>     <span class="string">/works/log/*/test/**/*-error.log</span></span><br><span class="line">    <span class="string">Path</span>             <span class="string">/works/log/*/test/**/*.log</span></span><br><span class="line">    <span class="string">Buffer_Chunk_Size</span> <span class="string">4096KB</span></span><br><span class="line">    <span class="string">Buffer_Max_Size</span>   <span class="string">10240KB</span></span><br><span class="line"></span><br><span class="line"><span class="string">[INPUT]</span></span><br><span class="line">    <span class="string">Name</span>             <span class="string">tail</span></span><br><span class="line">    <span class="string">Tag</span>              <span class="string">selftest</span></span><br><span class="line">    <span class="string">path_key</span>         <span class="string">filename</span></span><br><span class="line">    <span class="comment">#read_from_head   true</span></span><br><span class="line">    <span class="string">multiline.parser</span> <span class="string">multiline-regex</span></span><br><span class="line">    <span class="string">Exclude_Path</span>     <span class="string">/works/log/*/selftest/**/*-error.log</span></span><br><span class="line">    <span class="string">Path</span>             <span class="string">/works/log/*/selftest/**/*.log</span></span><br><span class="line">    <span class="string">Buffer_Chunk_Size</span> <span class="string">4096KB</span></span><br><span class="line">    <span class="string">Buffer_Max_Size</span>   <span class="string">10240KB</span></span><br><span class="line"></span><br><span class="line"><span class="string">[INPUT]</span></span><br><span class="line">    <span class="string">Name</span>             <span class="string">tail</span></span><br><span class="line">    <span class="string">Tag</span>              <span class="string">sandbox</span></span><br><span class="line">    <span class="string">path_key</span>         <span class="string">filename</span></span><br><span class="line">    <span class="comment">#read_from_head   true</span></span><br><span class="line">    <span class="string">multiline.parser</span> <span class="string">multiline-regex</span></span><br><span class="line">    <span class="string">Exclude_Path</span>     <span class="string">/works/log/*/sandbox/**/*-error.log</span></span><br><span class="line">    <span class="string">Path</span>             <span class="string">/works/log/*/sandbox/**/*.log</span></span><br><span class="line">    <span class="string">Buffer_Chunk_Size</span> <span class="string">4096KB</span></span><br><span class="line">    <span class="string">Buffer_Max_Size</span>   <span class="string">10240KB</span></span><br><span class="line"></span><br><span class="line"><span class="string">[INPUT]</span></span><br><span class="line">    <span class="string">Name</span>             <span class="string">tail</span></span><br><span class="line">    <span class="string">Tag</span>              <span class="string">uat</span></span><br><span class="line">    <span class="string">path_key</span>         <span class="string">filename</span></span><br><span class="line">    <span class="comment">#read_from_head   true</span></span><br><span class="line">    <span class="string">multiline.parser</span> <span class="string">multiline-regex</span></span><br><span class="line">    <span class="string">Exclude_Path</span>     <span class="string">/works/log/*/uat/**/*-error.log</span></span><br><span class="line">    <span class="string">Path</span>             <span class="string">/works/log/*/uat/**/*.log</span></span><br><span class="line">    <span class="string">Buffer_Chunk_Size</span> <span class="string">4096KB</span></span><br><span class="line">    <span class="string">Buffer_Max_Size</span>   <span class="string">10240KB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [FILTER]</span></span><br><span class="line"><span class="comment">#     name             parser</span></span><br><span class="line"><span class="comment">#     match            *</span></span><br><span class="line"><span class="comment">#     key_name         log</span></span><br><span class="line"><span class="comment">#     parser           named-capture-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [FILTER]</span></span><br><span class="line"><span class="comment">#     Name    grep</span></span><br><span class="line"><span class="comment">#     Match   configuration</span></span><br><span class="line"><span class="comment">#     #Exclude log level=INFO </span></span><br><span class="line"><span class="comment">#     Regex    log =WARN</span></span><br><span class="line"></span><br><span class="line"><span class="string">[OUTPUT]</span></span><br><span class="line">    <span class="string">Name</span>        <span class="string">kafka</span></span><br><span class="line">    <span class="string">Match</span>       <span class="string">dev</span></span><br><span class="line">    <span class="string">Brokers</span>     <span class="number">192.168</span><span class="number">.80</span><span class="number">.98</span><span class="string">:9092</span></span><br><span class="line">    <span class="string">Topics</span>      <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="string">[OUTPUT]</span></span><br><span class="line">    <span class="string">Name</span>        <span class="string">kafka</span></span><br><span class="line">    <span class="string">Match</span>       <span class="string">test</span></span><br><span class="line">    <span class="string">Brokers</span>     <span class="number">192.168</span><span class="number">.80</span><span class="number">.98</span><span class="string">:9092</span></span><br><span class="line">    <span class="string">Topics</span>      <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="string">[OUTPUT]</span></span><br><span class="line">    <span class="string">Name</span>        <span class="string">kafka</span></span><br><span class="line">    <span class="string">Match</span>       <span class="string">selftest</span></span><br><span class="line">    <span class="string">Brokers</span>     <span class="number">192.168</span><span class="number">.80</span><span class="number">.98</span><span class="string">:9092</span></span><br><span class="line">    <span class="string">Topics</span>      <span class="string">selftest</span></span><br><span class="line"></span><br><span class="line"><span class="string">[OUTPUT]</span></span><br><span class="line">    <span class="string">Name</span>        <span class="string">kafka</span></span><br><span class="line">    <span class="string">Match</span>       <span class="string">sandbox</span></span><br><span class="line">    <span class="string">Brokers</span>     <span class="number">192.168</span><span class="number">.80</span><span class="number">.98</span><span class="string">:9092</span></span><br><span class="line">    <span class="string">Topics</span>      <span class="string">sandbox</span></span><br><span class="line"></span><br><span class="line"><span class="string">[OUTPUT]</span></span><br><span class="line">    <span class="string">Name</span>        <span class="string">kafka</span></span><br><span class="line">    <span class="string">Match</span>       <span class="string">uat</span></span><br><span class="line">    <span class="string">Brokers</span>     <span class="number">192.168</span><span class="number">.80</span><span class="number">.98</span><span class="string">:9092</span></span><br><span class="line">    <span class="string">Topics</span>      <span class="string">uat</span></span><br></pre></td></tr></table></figure>
<p>fluent-bit/parsers_multiline.conf(if need)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[MULTILINE_PARSER]</span></span><br><span class="line">    <span class="string">name</span>          <span class="string">multiline-regex</span></span><br><span class="line">    <span class="string">type</span>          <span class="string">regex</span></span><br><span class="line">    <span class="string">flush_timeout</span> <span class="number">3000</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Regex rules for multiline parsing</span></span><br><span class="line">    <span class="comment"># ---------------------------------</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># configuration hints:</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#  - first state always has the name: start_state</span></span><br><span class="line">    <span class="comment">#  - every field in the rule must be inside double quotes</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># rules |   state name  | regex pattern                  | next state</span></span><br><span class="line">    <span class="comment"># ------|---------------|--------------------------------------------</span></span><br><span class="line">    <span class="string">rule</span>      <span class="string">"start_state"</span>   <span class="string">"/^\d&#123;4&#125;\-\d&#123;2&#125;\-\d&#123;2&#125; \d&#123;1,2&#125;\:\d&#123;2&#125;\:\d&#123;2&#125;.*/"</span>  <span class="string">"cont"</span></span><br><span class="line">    <span class="comment">#rule      "cont"          "/^([a-zA-Z]|\s)+.*/"                             "cont"</span></span><br><span class="line">    <span class="string">rule</span>      <span class="string">"cont"</span>          <span class="string">"/^(?!\d&#123;4&#125;\-\d&#123;2&#125;\-\d&#123;2&#125;).*/"</span>                    <span class="string">"cont"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#[PARSER]</span></span><br><span class="line"><span class="comment">#    Name named-capture-test</span></span><br><span class="line"><span class="comment">#    Format regex</span></span><br><span class="line"><span class="comment">#    Regex /^(?&lt;date&gt;\d&#123;4&#125;\-\d&#123;2&#125;\-\d&#123;2&#125; \d&#123;1,2&#125;\:\d&#123;2&#125;\:\d&#123;2&#125;)\.\d&#123;3&#125;\s+(?&lt;message&gt;.*)/m</span></span><br></pre></td></tr></table></figure>
<p>Kakfa docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#https://segmentfault.com/a/1190000021746086</span></span><br><span class="line"><span class="comment">#https://github.com/wurstmeister/kafka-docker</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wurstmeister/zookeeper</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2182</span><span class="string">:2181</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kafka9094:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wurstmeister/kafka</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9092</span><span class="string">:9092</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KAFKA_BROKER_ID:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="string">PLAINTEXT://192.168.80.98:9092</span></span><br><span class="line">      <span class="attr">KAFKA_CREATE_TOPICS:</span> <span class="string">"dev:3:1,test:3:1,selftest:3:1,uat:3:1,sandbox:3:1"</span>   <span class="comment">#kafka启动后初始化一个有3个partition(分区)1个副本名的topic</span></span><br><span class="line">      <span class="attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="string">zookeeper:2181</span></span><br><span class="line">      <span class="attr">KAFKA_LISTENERS:</span> <span class="string">PLAINTEXT://0.0.0.0:9092</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./kafka-logs:/kafka</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br></pre></td></tr></table></figure>
<p>alertmanager-config.yaml</p>
<p><a href="https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/alert-manager-config" target="_blank" rel="noopener">https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/alert-manager-config</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">smtp_smarthost:</span> <span class="string">'smtp.exmail.qq.com:25'</span></span><br><span class="line">  <span class="attr">smtp_from:</span> <span class="string">'xxx@xxx.com'</span></span><br><span class="line">  <span class="attr">smtp_auth_username:</span> <span class="string">'xxx@xxx.com'</span></span><br><span class="line">  <span class="attr">smtp_auth_password:</span> <span class="string">'xxx'</span></span><br><span class="line">  <span class="attr">smtp_require_tls:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment">#该参数定义了当Alertmanager持续多长时间未接收到告警后标记告警状态为resolved（已解决）。该参数的定义可能会影响到告警恢复通知的接收时间，读者可根据自己的实际场景进行定义，其默认值为5分钟</span></span><br><span class="line">  <span class="attr">resolve_timeout:</span> <span class="string">10m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">templates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">'/etc/alertmanager/config/*-resolved.tmpl'</span></span><br><span class="line"><span class="bullet">-</span> </span><br><span class="line"><span class="comment"># 路由分组</span></span><br><span class="line"><span class="comment">#https://blog.csdn.net/bluuusea/article/details/104619235</span></span><br><span class="line"><span class="comment">#https://github.com/prometheus/alertmanager/blob/main/doc/examples/simple.yml</span></span><br><span class="line"><span class="comment">#https://kebingzao.com/2022/11/29/prometheus-4-alertmanager/</span></span><br><span class="line"><span class="comment">#https://zhuanlan.zhihu.com/p/63270049</span></span><br><span class="line"><span class="comment">#https://blog.csdn.net/qq_37843943/article/details/120665690</span></span><br><span class="line"><span class="comment">#https://blog.51cto.com/u_14205795/4561323</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="comment"># 该节点中的警报会按'env', 'alertname', 'biz_group', 'biz_key'做 Group，每个分组中最多每group_interval发送一条警报，同样的警报最多repeat_interval发送一次</span></span><br><span class="line">  <span class="comment"># 分组规则，如果满足group_by中包含的标签，则这些报警会合并为一个通知发给receiver</span></span><br><span class="line">  <span class="attr">group_by:</span> <span class="string">['env',</span> <span class="string">'alertname'</span><span class="string">,</span> <span class="string">'biz_group'</span><span class="string">,</span> <span class="string">'biz_key'</span><span class="string">]</span></span><br><span class="line">  <span class="comment"># 设置等待时间，在此等待时间内如果接收到多个报警，则会合并成一个通知发送给receiver</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line">  <span class="comment"># 收到相同的分组告警通知的时间间隔(上下两组发送告警的间隔时间)，如果满足，则再会查找是否已经满足repeat_interval，如果满足，则会再次发送</span></span><br><span class="line">  <span class="comment"># https://www.dianbanjiu.com/post/alertmanager-%E4%B8%AD%E4%B8%89%E4%B8%AA%E6%97%B6%E9%97%B4%E5%8F%82%E6%95%B0%E4%B8%8A%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/</span></span><br><span class="line">  <span class="comment"># 再次发送时间在(group_interval+repeat_interval)左右</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="comment"># 发送相同告警的时间间隔，如：4h，表示4小时内不会发送相同的报警</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">4h</span></span><br><span class="line">  <span class="comment"># 顶级路由配置的接收者（匹配不到子级路由，会使用根路由发送报警）</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">'emailreceivers'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 上面所有的属性都由所有子路由继承，并且可以在每个子路由上进行覆盖。</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">      <span class="comment">#用于系统默认BaseException的异常</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">emailreceivers</span></span><br><span class="line">      <span class="attr">group_by:</span> <span class="string">['env',</span> <span class="string">'alertname'</span><span class="string">,</span> <span class="string">'biz_group'</span><span class="string">,</span> <span class="string">'biz_key'</span><span class="string">,</span> <span class="string">'biz_value'</span><span class="string">]</span></span><br><span class="line">      <span class="attr">group_wait:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">group_interval:</span> <span class="string">1m</span></span><br><span class="line">      <span class="attr">repeat_interval:</span> <span class="string">3m</span></span><br><span class="line">      <span class="comment">#默认为false。false：配置到满足条件的子节点点后直接返回，true：匹配到子节点后还会继续遍历后续子节点</span></span><br><span class="line">      <span class="attr">continue:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">matchers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">biz_group="XPAY-SYSTEM-ERROR"</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">#用于业务告警</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">alertmanager-webhook</span></span><br><span class="line">    <span class="comment">#- receiver: emailreceivers</span></span><br><span class="line">    <span class="comment">#- receiver: wecomreceivers</span></span><br><span class="line">      <span class="attr">group_by:</span> <span class="string">['env',</span> <span class="string">'alertname'</span><span class="string">,</span> <span class="string">'biz_group'</span><span class="string">,</span> <span class="string">'biz_key'</span><span class="string">,</span> <span class="string">'biz_value'</span><span class="string">]</span></span><br><span class="line">      <span class="attr">group_wait:</span> <span class="string">0s</span></span><br><span class="line">      <span class="attr">group_interval:</span> <span class="string">1m</span></span><br><span class="line">      <span class="attr">repeat_interval:</span> <span class="string">2m</span></span><br><span class="line">      <span class="comment">#默认为false。false：配置到满足条件的子节点点后直接返回，true：匹配到子节点后还会继续遍历后续子节点</span></span><br><span class="line">      <span class="attr">continue:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">matchers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">biz_group!~"XPAY-SYSTEM-ERROR"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#定义所有接收者</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'alertmanager-webhook'</span></span><br><span class="line">    <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">'http://192.168.101.82:8088/alert'</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'emailreceivers'</span></span><br><span class="line">    <span class="attr">email_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">'xxx@xxx.com'</span></span><br><span class="line">      <span class="attr">html:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "email.to.html" . &#125;&#125;</span>'</span></span><br><span class="line">      <span class="attr">headers:</span> </span><br><span class="line">        <span class="comment">#subject: ' &#123;&#123; .CommonAnnotations.summary &#125;&#125; &#123;&#123; if eq .Status "firing" &#125;&#125; DOWN &#123;&#123; else if eq .Status "resolved" &#125;&#125; UP &#123;&#123;end&#125;&#125;'</span></span><br><span class="line">        <span class="attr">subject:</span> <span class="string">'[<span class="template-variable">&#123;&#123; .Status &#125;&#125;</span>]<span class="template-variable">&#123;&#123; .CommonAnnotations.summary &#125;&#125;</span>'</span></span><br><span class="line">        <span class="comment">#subject: '预警通知'</span></span><br><span class="line">      <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'wecomreceivers'</span></span><br><span class="line">    <span class="attr">wechat_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">corp_id:</span> <span class="string">'xxx'</span></span><br><span class="line">      <span class="attr">to_user:</span> <span class="string">'SZ122'</span></span><br><span class="line">      <span class="comment">#to_party: 'SZ122 | SZ097'</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "wechat.default.message" . &#125;&#125;</span>'</span></span><br><span class="line">      <span class="attr">agent_id:</span> <span class="string">'xxx'</span></span><br><span class="line">      <span class="attr">api_secret:</span> <span class="string">'xxx'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抑制器配置：抑制是指当某以此告警发出后，可以停止重复发送由此告警引发的其他告警的机制</span></span><br><span class="line"><span class="comment"># https://blog.csdn.net/qq_42883074/article/details/115544031</span></span><br><span class="line"><span class="comment">#当我们前面已经有一个告警了，那么后面的告警规则在触发的时候会先翻一下前面的已经触发的告警，去查看是否有severity: 'critical'的标签</span></span><br><span class="line"><span class="comment">#如果有了，那么去对比['alertname', 'biz_group', 'biz_key']标签是不是相同，如果是的话，</span></span><br><span class="line"><span class="comment">#那么去查看一下自己准备发的告警里标签是否存在severity: 'warning'，如果是，就不告警了</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="comment"># 源标签警报触发时抑制含有目标标签的警报</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span></span><br><span class="line">      <span class="comment"># 此处的抑制匹配一定在最上面的route中配置不然，会提示找不key。</span></span><br><span class="line">      <span class="comment"># 前一个告警规则的标签</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">'critical'</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="comment"># 目标标签值正则匹配，可以是正则表达式如: ".*MySQL.*"</span></span><br><span class="line">      <span class="comment"># 后面触发告警规则的标签</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">'High'</span></span><br><span class="line">    <span class="comment"># 确保这个配置下的标签内容相同才会抑制，也就是说警报中必须有这三个标签值才会被抑制。</span></span><br><span class="line">    <span class="attr">equal:</span> <span class="string">['env',</span> <span class="string">'alertname'</span><span class="string">,</span> <span class="string">'biz_group'</span><span class="string">,</span> <span class="string">'biz_key'</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>loki/rules/fake/rules.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">系统日志</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">系统日志-系统统一错误日志</span></span><br><span class="line">        <span class="comment">#=: exactly equal</span></span><br><span class="line">        <span class="comment">#!=: not equal</span></span><br><span class="line">        <span class="comment">#=~: regex matches</span></span><br><span class="line">        <span class="comment">#!~: regex does not match</span></span><br><span class="line">        <span class="comment">#expr: sum by (env, app_name) (count_over_time(&#123;env=~"dev", app_name="account-server"&#125;|unpack|bizKey=~"\\w+"[1m]) &gt;=1)</span></span><br><span class="line">        <span class="comment">#必须大于loki-config.yaml中的"evaluation_interval: 3s"的值</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-SYSTEM-ERROR",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[10s])</span> <span class="string">&gt;=1)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#emails: "xxx@xxx.com"</span></span><br><span class="line">          <span class="comment">#emailTemplate: "email1"</span></span><br><span class="line">          <span class="comment">#smsPhones: "11111111111,22222222222"</span></span><br><span class="line">          <span class="comment">#ttsPhones: "11111111111,22222222222"</span></span><br><span class="line">          <span class="comment">#wecomUrl: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="comment">#wecomTemplate: "wecom1"</span></span><br><span class="line">          <span class="comment">#只要捕捉到异常后，直接邮件通知相关对象通知一次</span></span><br><span class="line">          <span class="attr">emails:</span> <span class="string">"xxx@xxx.com"</span></span><br><span class="line">          <span class="attr">emailTemplate:</span> <span class="string">"email1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br><span class="line">          </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">支付</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">交易异常</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-PAYMENT",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[5m])</span> <span class="string">&gt;=10)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#在5min内出现10笔同类型的超时，则直接电话+企业微信通知相关对象按照0min，3min时间间隔通知二次</span></span><br><span class="line">          <span class="attr">ttsPhones:</span> <span class="string">"11111111111,22222222222"</span></span><br><span class="line">          <span class="attr">wecomUrl:</span> <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="attr">wecomTemplate:</span> <span class="string">"wecom1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">对账</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">外部对账失败</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-RECONCILICATION",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[10s])</span> <span class="string">&gt;=1)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#只要捕捉到异常后，直接企业微信通知相关对象通知一次</span></span><br><span class="line">          <span class="attr">wecomUrl:</span> <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="attr">wecomTemplate:</span> <span class="string">"wecom1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">内部对账失败</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-RECONCILICATION",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[10s])</span> <span class="string">&gt;=1)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#只要捕捉到异常后，直接企业微信通知相关对象通知一次</span></span><br><span class="line">          <span class="attr">wecomUrl:</span> <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="attr">wecomTemplate:</span> <span class="string">"wecom1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">结算</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">渠道结算失败</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-SETTLEMENT",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[10s])</span> <span class="string">&gt;=1)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#只要捕捉到异常后，直接企业微信通知相关对象通知一次</span></span><br><span class="line">          <span class="attr">wecomUrl:</span> <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="attr">wecomTemplate:</span> <span class="string">"wecom1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">商户结算失败</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-SETTLEMENT",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[10s])</span> <span class="string">&gt;=1)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#只要捕捉到异常后，直接企业微信通知相关对象通知一次</span></span><br><span class="line">          <span class="attr">wecomUrl:</span> <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="attr">wecomTemplate:</span> <span class="string">"wecom1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br><span class="line">          </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">服务商结算失败</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-SETTLEMENT",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[10s])</span> <span class="string">&gt;=1)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#只要捕捉到异常后，直接企业微信通知相关对象通知一次</span></span><br><span class="line">          <span class="attr">wecomUrl:</span> <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="attr">wecomTemplate:</span> <span class="string">"wecom1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">审批</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">审批失败</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-APPROVAL",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[10s])</span> <span class="string">&gt;=1)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#只要捕捉到异常后，直接企业微信通知相关对象通知一次</span></span><br><span class="line">          <span class="attr">wecomUrl:</span> <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="attr">wecomTemplate:</span> <span class="string">"wecom1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">业务阻断</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">业务阻断</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-BIZ-BLOCK",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[10s])</span> <span class="string">&gt;=1)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#只要捕捉到异常后，直接电话+企业微信通知相关对象</span></span><br><span class="line">          <span class="attr">wecomUrl:</span> <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="attr">wecomTemplate:</span> <span class="string">"wecom1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">会计</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">会计异常</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(env,</span> <span class="string">biz_group,</span> <span class="string">biz_key,</span> <span class="string">biz_desc,</span> <span class="string">biz_value)</span> <span class="string">(count_over_time(&#123;biz_group="XPAY-ACCOUNTING",biz_key=~".+",biz_desc=~".+",biz_value=~".+"&#125;[10s])</span> <span class="string">&gt;=1)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">High</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">silenceResolved:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="comment">#只要捕捉到异常后，直接企业微信通知相关对象通知一次</span></span><br><span class="line">          <span class="attr">wecomUrl:</span> <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=111122223333"</span></span><br><span class="line">          <span class="attr">wecomTemplate:</span> <span class="string">"wecom1"</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_desc &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.biz_value &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">count:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>
<p>config/WebCom-resolved.tmpl</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">define</span> <span class="string">"wechat.default.message"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">gt</span> <span class="string">(len</span> <span class="string">.Alerts.Firing)</span> <span class="number">0</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$index,</span> <span class="string">$alert</span> <span class="string">:=</span> <span class="string">.Alerts</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">$index</span> <span class="number">0</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">**********[&#123;&#123;</span> <span class="string">$alert.Status</span> <span class="string">&#125;&#125;]告警通知**********</span></span><br><span class="line"><span class="string">模块名称:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Labels.alertname</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">预警级别:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Labels.severity</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">故障业务:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Labels.biz_key</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">=====================</span></span><br><span class="line"><span class="string">预警名称:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Annotations.summary</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">预警警详情:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Annotations.description</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">错误次数:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Annotations.count</span>  <span class="string">&#125;&#125;次</span></span><br><span class="line"><span class="string">故障时间:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.StartsAt.Local.Format</span> <span class="string">"2006-01-02 15:04:05"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">gt</span> <span class="string">(len</span> <span class="string">.Alerts.Resolved)</span> <span class="number">0</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$index,</span> <span class="string">$alert</span> <span class="string">:=</span> <span class="string">.Alerts</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">$index</span> <span class="number">0</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">**********恢复通知**********</span></span><br><span class="line"><span class="string">模块名称:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Labels.alertname</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">预警级别:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Labels.severity</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">故障业务:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Labels.biz_key</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">=====================</span></span><br><span class="line"><span class="string">预警名称:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Annotations.summary</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">预警警详情:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Annotations.description</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">错误次数:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Annotations.count</span>  <span class="string">&#125;&#125;次</span></span><br><span class="line"><span class="string">故障时间:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.StartsAt.Local.Format</span> <span class="string">"2006-01-02 15:04:05"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">恢复时间:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.EndsAt.Local.Format</span> <span class="string">"2006-01-02 15:04:05"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>config/WebCom.tmpl</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">define</span> <span class="string">"wechat.default.message"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">gt</span> <span class="string">(len</span> <span class="string">.Alerts.Firing)</span> <span class="number">0</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$index,</span> <span class="string">$alert</span> <span class="string">:=</span> <span class="string">.Alerts</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">$index</span> <span class="number">0</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">**********[&#123;&#123;</span> <span class="string">$alert.Status</span> <span class="string">&#125;&#125;]告警通知**********</span></span><br><span class="line"><span class="string">模块名称:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Labels.alertname</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">预警级别:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Labels.severity</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">故障业务:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Labels.biz_key</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">=====================</span></span><br><span class="line"><span class="string">预警名称:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Annotations.summary</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">预警警详情:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Annotations.description</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">错误次数:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.Annotations.count</span>  <span class="string">&#125;&#125;次</span></span><br><span class="line"><span class="string">故障时间:</span> <span class="string">&#123;&#123;</span> <span class="string">$alert.StartsAt.Local.Format</span> <span class="string">"2006-01-02 15:04:05"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>config/Email-resolved.tmpl</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">define</span> <span class="string">"email.to.html"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">gt</span> <span class="string">(len</span> <span class="string">.Alerts.Firing)</span> <span class="number">0</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$index,</span> <span class="string">$alert</span> <span class="string">:=</span> <span class="string">.Alerts</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">=========</span> <span class="string">ERROR</span> <span class="string">==========&lt;br&gt;</span></span><br><span class="line"><span class="string">模块名称:</span> <span class="string">&#123;&#123;</span> <span class="string">.Labels.alertname</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">预警级别:</span> <span class="string">&#123;&#123;</span> <span class="string">.Labels.severity</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">故障业务:</span> <span class="string">&#123;&#123;</span> <span class="string">.Labels.biz_key</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">=====================&lt;br/&gt;</span></span><br><span class="line"><span class="string">预警名称:</span> <span class="string">&#123;&#123;</span> <span class="string">.Annotations.summary</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">预警详情:</span> <span class="string">&#123;&#123;</span> <span class="string">.Annotations.description</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">错误次数:</span> <span class="string">&#123;&#123;</span> <span class="string">.Annotations.count</span> <span class="string">&#125;&#125;次&lt;br&gt;</span></span><br><span class="line"><span class="string">故障时间:</span> <span class="string">&#123;&#123;</span> <span class="string">.StartsAt.Format</span> <span class="string">"2020-01-02 15:04:05"</span><span class="string">&#125;&#125;</span> <span class="string">&lt;br&gt;</span></span><br><span class="line"><span class="string">=========</span> <span class="string">END</span> <span class="string">==========&lt;br&gt;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">gt</span> <span class="string">(len</span> <span class="string">.Alerts.Resolved)</span> <span class="number">0</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$index,</span> <span class="string">$alert</span> <span class="string">:=</span> <span class="string">.Alerts</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">=========</span> <span class="string">INFO</span> <span class="string">==========&lt;br&gt;</span></span><br><span class="line"><span class="string">模块名称:</span> <span class="string">&#123;&#123;</span> <span class="string">.Labels.alertname</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">预警级别:</span> <span class="string">&#123;&#123;</span> <span class="string">.Labels.severity</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">故障业务:</span> <span class="string">&#123;&#123;</span> <span class="string">.Labels.biz_key</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">=====================&lt;br/&gt;</span></span><br><span class="line"><span class="string">预警名称:</span> <span class="string">&#123;&#123;</span> <span class="string">.Annotations.summary</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">预警详情:</span> <span class="string">&#123;&#123;</span> <span class="string">.Annotations.description</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">错误次数:</span> <span class="string">&#123;&#123;</span> <span class="string">.Annotations.count</span> <span class="string">&#125;&#125;次&lt;br&gt;</span></span><br><span class="line"><span class="string">故障时间:</span> <span class="string">&#123;&#123;</span> <span class="string">.StartsAt.Format</span> <span class="string">"2020-01-02 15:04:05"</span><span class="string">&#125;&#125;</span> <span class="string">&lt;br&gt;</span></span><br><span class="line"><span class="string">恢复时间：&#123;&#123;</span> <span class="string">.EndsAt.Format</span> <span class="string">"2006-01-02 15:04:05"</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">=========</span> <span class="string">END</span> <span class="string">==========&lt;br&gt;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>config/Email.tmpl</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">define</span> <span class="string">"email.to.html"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">range</span> <span class="string">.Alerts</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">模块名称:</span> <span class="string">&#123;&#123;</span> <span class="string">.Labels.alertname</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">预警级别:</span> <span class="string">&#123;&#123;</span> <span class="string">.Labels.severity</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">故障业务:</span> <span class="string">&#123;&#123;</span> <span class="string">.Labels.biz_key</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">=====================&lt;br/&gt;</span></span><br><span class="line"><span class="string">预警名称:</span> <span class="string">&#123;&#123;</span> <span class="string">.Annotations.summary</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">预警详情:</span> <span class="string">&#123;&#123;</span> <span class="string">.Annotations.description</span> <span class="string">&#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">错误次数:</span> <span class="string">&#123;&#123;</span> <span class="string">.Annotations.count</span> <span class="string">&#125;&#125;次&lt;br&gt;</span></span><br><span class="line"><span class="string">故障时间:</span> <span class="string">&#123;&#123;</span> <span class="string">.StartsAt.Format</span> <span class="string">"2020-01-02 15:04:05"</span><span class="string">&#125;&#125;</span> <span class="string">&lt;br&gt;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>迁移grafana:</p>
<p><a href="https://www.jianshu.com/p/bc37e2fc15e7" target="_blank" rel="noopener">https://www.jianshu.com/p/bc37e2fc15e7</a></p>
<h4 id="Collecting-type"><a href="#Collecting-type" class="headerlink" title="Collecting type"></a>Collecting type</h4><p>There is 2 way to collect logs:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1: fluent bit---&gt;kafka---&gt;promtail---&gt;loki</span><br><span class="line">                      ---&gt;logstash---&gt;ES</span><br><span class="line">2: promtail---&gt;loki</span><br><span class="line">3: fluent bit---&gt;loki</span><br></pre></td></tr></table></figure>
<p>Recommended: fluent bit—&gt;kafka—&gt;promtail—&gt;loki</p>
<h4 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h4><p>Not recommend, just for local study.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#depend on Linux: https://grafana.com/docs/loki/latest/installation/docker/</span></span><br><span class="line"><span class="comment">#Install with Docker Compose</span></span><br><span class="line">wget https://raw.githubusercontent.com/grafana/loki/v2.7.0/production/docker-compose.yaml -O docker-compose.yaml</span><br><span class="line">docker-compose -f docker-compose.yaml up</span><br></pre></td></tr></table></figure>
<p>The modified docker-compose.yaml as follows:</p>
<p>docker-compose.yaml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">loki:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">loki:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grafana/loki:2.4.1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/mnt/config</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"3100:3100"</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-config.file=/mnt/config/loki-config.yaml</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">loki</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">promtail:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grafana/promtail:2.4.1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/mnt/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt/d/works/log:/works/log</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-config.file=/mnt/config/promtail-config.yaml</span> <span class="string">-client.external-labels=hostname=$&#123;HOSTNAME&#125;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">loki</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">grafana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grafana/grafana:latest</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/works/loki/docker/grafana.ini:/etc/grafana/grafana.ini</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-config.file=/mnt/config/promtail-config.yaml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"3000:3000"</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">loki</span></span><br></pre></td></tr></table></figure>
<p>Starting:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Starting:</span></span><br><span class="line">docker-compose -f docker-compose.yaml up</span><br><span class="line"></span><br><span class="line"><span class="comment">#Deleting:</span></span><br><span class="line">docker-compose -f docker-compose.yaml rm -vf</span><br></pre></td></tr></table></figure>
<p>When it’s started, you can check the status using the following url:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3100/ready</span><br><span class="line">http://localhost:3100/metrics</span><br></pre></td></tr></table></figure>
<p>Grafana URL is: <a href="http://localhost:3000/" target="_blank" rel="noopener">http://localhost:3000/</a>, default account is admin/admin</p>
<h4 id="Grafana-Configuration"><a href="#Grafana-Configuration" class="headerlink" title="Grafana Configuration"></a>Grafana Configuration</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">env:</span><br><span class="line">  Query: label_values(env)</span><br><span class="line">system:</span><br><span class="line">  Query: label_values(&#123;belongs=<span class="string">"company"</span>, filename=~<span class="string">".*<span class="variable">$&#123;env&#125;</span>.*"</span>&#125;, filename)</span><br><span class="line">  Regex: /works\/<span class="built_in">log</span>\/.+?\/.+?\/(.+?)\/.*/</span><br><span class="line">hostname:</span><br><span class="line">  Query: label_values(&#123;belongs=<span class="string">"company"</span>, filename=~<span class="string">".*<span class="variable">$&#123;env&#125;</span>/<span class="variable">$&#123;system&#125;</span>.*"</span>&#125;, hostname)</span><br><span class="line">filename:</span><br><span class="line">  Query: label_values(&#123;belongs=<span class="string">"company"</span>, filename=~<span class="string">".*<span class="variable">$&#123;env&#125;</span>/<span class="variable">$&#123;system&#125;</span>.*"</span>, filename!~<span class="string">".*(?:error|tmlog).*"</span>&#125;, filename)</span><br><span class="line">  Regex: /.*\/(.+\.<span class="built_in">log</span>)/</span><br><span class="line">search:</span><br><span class="line">  Type: Text box</span><br><span class="line">Log browser:</span><br><span class="line">  &#123;env=<span class="string">"<span class="variable">$&#123;env&#125;</span>"</span>, app_name=<span class="string">"<span class="variable">$&#123;system&#125;</span>"</span>, hostname=~<span class="string">".*<span class="variable">$&#123;hostname&#125;</span>.*"</span>, filename=~<span class="string">".*<span class="variable">$&#123;filename&#125;</span>.*"</span>&#125;|~<span class="string">"(?i)<span class="variable">$search</span>"</span></span><br></pre></td></tr></table></figure>
<h2 id="promtail"><a href="#promtail" class="headerlink" title="promtail"></a>promtail</h2><p>Promtail is an agent which ships the contents of local logs to a private Grafana Loki instance or Grafana Cloud. It is usually deployed to every machine that has applications needed to be monitored.</p>
<p>More details: <a href="https://grafana.com/docs/loki/latest/clients/promtail/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/clients/promtail/</a></p>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><h3 id="Promtail-Config"><a href="#Promtail-Config" class="headerlink" title="Promtail Config"></a>Promtail Config</h3><p>All of the rule of collecting logs will be configured in the “promtail-config.yaml”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">- job_name: saas-tenant-management-system</span><br><span class="line">  pipeline_stages:</span><br><span class="line">  - match:</span><br><span class="line">      selector: &apos;&#123;app_name=&quot;saas-tenant-management-system&quot;&#125;&apos;</span><br><span class="line">      stages:</span><br><span class="line">      #https://grafana.com/docs/loki/latest/clients/promtail/stages/multiline/</span><br><span class="line">      #Working on collecting the multiline, like exception logs</span><br><span class="line">      - multiline:</span><br><span class="line">          firstline: &apos;^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125; \d&#123;1,2&#125;:\d&#123;2&#125;:\d&#123;2&#125;&apos;</span><br><span class="line">          max_lines: 500</span><br><span class="line">      #https://grafana.com/docs/loki/latest/clients/promtail/stages/regex/</span><br><span class="line">      - regex:</span><br><span class="line">          expression: &quot;^(?P&lt;timestamp&gt;\\d&#123;4&#125;\\-\\d&#123;2&#125;\\-\\d&#123;2&#125; \\d&#123;1,2&#125;\\:\\d&#123;2&#125;\\:\\d&#123;2&#125;)\\.\\d+ .*$&quot;</span><br><span class="line">      #https://grafana.com/docs/loki/latest/fundamentals/labels/</span><br><span class="line">      #Working for the variables of searching.</span><br><span class="line">      #- labels:</span><br><span class="line">      #    time:</span><br><span class="line">      - timestamp:</span><br><span class="line">          format: RFC3339Nano</span><br><span class="line">          source: timestamp</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">      - localhost</span><br><span class="line">    labels:</span><br><span class="line">      app_name: saas-tenant-management-system</span><br><span class="line">      belongs: alphatimes</span><br><span class="line">      __path__: /works/log/alphatimes/**/saas-tenant-management-system/**/*.log</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>Notice:</p>
<p>If multline fields are configured, it won’t appear in the lables of seaching. it conflict witch regex stage. For example:</p>
<p>“loglevel” field configured in regex stage, if you the “loglevel” contain multiline, you wan to search by: “{loglevel=”ERROR”}”, it won’t display the multiline logs, just single log, althought “loglevel” contain multiline logs.</p>
<h3 id="Grafana-Config"><a href="#Grafana-Config" class="headerlink" title="Grafana Config"></a>Grafana Config</h3><p>Grafana 6.0 and more recent versions have built-in support for Grafana Loki. Use Grafana 6.3 or a more recent version to take advantage of LogQL functionality.</p>
<p>Log into your Grafana instance. If this is your first time running Grafana, the username and password are both defaulted to admin.</p>
<p>In Grafana, go to Configuration &gt; Data Sources via the cog icon on the left sidebar.<br>Click the big + Add data source button.<br>Choose Loki from the list.</p>
<p>The http URL field should be the address of your Loki server. For example, when running locally or with Docker using port mapping, the address is likely <a href="http://localhost:3100" target="_blank" rel="noopener">http://localhost:3100</a>. When running with docker-compose or Kubernetes, the address is likely <a href="http://loki:3100" target="_blank" rel="noopener">http://loki:3100</a>.</p>
<p>To see the logs, click Explore on the sidebar, select the Loki datasource in the top-left dropdown, and then choose a log stream using the Log labels button.</p>
<h4 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h4><p>Creating a new dashboard named “Loki”(just first time), entering “dashboards settings”(gear icon):</p>
<p><img src="/images/Loki-Log-System/01.png" alt="01.png"></p>
<p>Env:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Query: label_values(env)</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/Loki-Log-System/02.png" alt="02.png"></p>
<p>System:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Query: label_values(&#123;belongs=&quot;company&quot;, filename=~&quot;.*$&#123;env&#125;.*&quot;&#125;, filename)</span><br><span class="line">Regex: /works\/log\/.+?\/.+?\/(.+?)\/.*/</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/Loki-Log-System/03.png" alt="03.png"></p>
<p>Hostname:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Query: label_values(&#123;belongs=&quot;company&quot;, filename=~&quot;.*$&#123;env&#125;/$&#123;system&#125;.*&quot;&#125;, hostname)</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/Loki-Log-System/04.png" alt="04.png"></p>
<p>Filename:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Query: label_values(&#123;belongs=&quot;company&quot;, filename=~&quot;.*$&#123;env&#125;/$&#123;system&#125;.*&quot;, filename!~&quot;.*(?:error|tmlog).*&quot;&#125;, filename)</span><br><span class="line">Regex: /.*\/(.+\.log)/</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/Loki-Log-System/10.png" alt="10.png"></p>
<p>Search: </p>
<p><img src="/images/Loki-Log-System/05.png" alt="05.png"></p>
<h4 id="Log-Panel"><a href="#Log-Panel" class="headerlink" title="Log Panel"></a>Log Panel</h4><p><img src="/images/Loki-Log-System/06.png" alt="06.png"></p>
<p><img src="/images/Loki-Log-System/07.png" alt="07.png"></p>
<p>Log browser:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;env=&quot;$&#123;env&#125;&quot;, app_name=&quot;$&#123;system&#125;&quot;, hostname=~&quot;.*$&#123;hostname&#125;.*&quot;, filename=~&quot;.*$&#123;filename&#125;.*&quot;&#125;|~&quot;(?i)$search&quot;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/Loki-Log-System/08.png" alt="08.png"></p>
<p><img src="/images/Loki-Log-System/09.png" alt="09.png"></p>
<h2 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h2><p>Using helm to install loki on the k8s environment easyly, but recommend it by customed congratulation:</p>
<p>Notice: It’s weird the way of Kubernetes couldn’t collection the logs completely, finally I used the docker to deploy.</p>
<h3 id="Heml"><a href="#Heml" class="headerlink" title="Heml"></a>Heml</h3><p>Installing heml:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Linux:</span></span><br><span class="line"><span class="comment">#https://helm.sh/docs/intro/install/#from-script</span></span><br><span class="line">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span><br><span class="line">chmod 700 get_helm.sh</span><br><span class="line">./get_helm.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#Windows:</span></span><br><span class="line"><span class="comment">#Members of the Helm community have contributed a Helm package build to Chocolatey. This package is generally up to date. run as administrator:</span></span><br><span class="line">choco install kubernetes-helm</span><br></pre></td></tr></table></figure>
<p>Pulling repositories:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#https://grafana.com/docs/loki/latest/installation/helm/</span></span><br><span class="line">helm repo add grafana https://grafana.github.io/helm-charts</span><br><span class="line">helm repo update</span><br><span class="line"><span class="built_in">cd</span> /works/loki</span><br><span class="line"></span><br><span class="line">kubectl create ns loki</span><br><span class="line"></span><br><span class="line"><span class="comment">#helm pull grafana/loki-stack</span></span><br><span class="line">helm pull grafana/grafana</span><br><span class="line">helm pull grafana/loki</span><br><span class="line"></span><br><span class="line">helm pull grafana/promtail</span><br><span class="line">tar zxvf promtail-3.11.0.tgz</span><br></pre></td></tr></table></figure>
<p>Configure:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Create PersistentVolume</span></span><br><span class="line">cat PersistentVolume.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: loki-pv-volume</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  storageClassName: loki</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 30Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/data/data/loki-data"</span></span><br><span class="line"></span><br><span class="line">kubectl create -f PersistentVolume.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#PersistentVolumeClaim.yaml</span></span><br><span class="line">cat PersistentVolumeClaim.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: loki-pv-claim</span><br><span class="line">  namespace: loki</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: loki</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 30Gi</span><br><span class="line"></span><br><span class="line">kubectl create -f PersistentVolumeClaim.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#Notice: Since the persistence volume based on local system, make sure hostPath.path is shared with multiple machines that loki may be deployed on. or you can use nfs model of persistence volume.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Making sure k8s has privilege to access hostPath.path. refer to the following configuration:</span></span><br><span class="line">securityContext.fsGroup: 10001</span><br><span class="line">  runAsGroup: 10001</span><br><span class="line">  runAsNonRoot: <span class="literal">true</span></span><br><span class="line">  runAsUser: 10001</span><br><span class="line"></span><br><span class="line"><span class="comment">#chown hostPath.path:</span></span><br><span class="line">sudo chown -R 10001:10001 /data/data/loki-data/</span><br><span class="line"></span><br><span class="line"><span class="comment">#configure loki</span></span><br><span class="line">vim loki/values.yaml</span><br><span class="line"><span class="comment">#Enable persistence</span></span><br><span class="line">persistence:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  size: 30Gi</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">  <span class="comment"># selector:</span></span><br><span class="line">  <span class="comment">#   matchLabels:</span></span><br><span class="line">  <span class="comment">#     app.kubernetes.io/name: loki</span></span><br><span class="line">  <span class="comment"># subPath: ""</span></span><br><span class="line">  existingClaim: loki-pv-claim</span><br><span class="line"></span><br><span class="line"><span class="comment">#configure promtail</span></span><br><span class="line">vim promtail/values.yaml</span><br><span class="line"></span><br><span class="line">extraArgs:</span><br><span class="line">  - -client.external-labels=hostname=$(HOSTNAME)</span><br><span class="line"></span><br><span class="line">config:</span><br><span class="line">  ...  </span><br><span class="line">  lokiAddress: http://loki:3100/loki/api/v1/push</span><br><span class="line"></span><br><span class="line">extraVolumes:</span><br><span class="line">  - name: journal</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /var/<span class="built_in">log</span>/journal</span><br><span class="line">  - name: logs</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /works/<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">extraVolumeMounts:</span><br><span class="line">  - name: journal</span><br><span class="line">    mountPath: /var/<span class="built_in">log</span>/journal</span><br><span class="line">    readOnly: <span class="literal">true</span></span><br><span class="line">  - name: logs</span><br><span class="line">    mountPath: /works/<span class="built_in">log</span></span><br><span class="line">    readOnly: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    extraScrapeConfigs: |</span><br><span class="line">      - job_name: company-job </span><br><span class="line">        pipeline_stages:</span><br><span class="line">        - match:</span><br><span class="line">            selector: <span class="string">'&#123;belongs="company", filename=~".*(?:error|tmlog).*"&#125;'</span></span><br><span class="line">            action: drop</span><br><span class="line">            drop_counter_reason: promtail_noisy_error</span><br><span class="line">        - match:</span><br><span class="line">            selector: <span class="string">'&#123;belongs="company"&#125;'</span></span><br><span class="line">            stages:</span><br><span class="line">            - regex:</span><br><span class="line">                <span class="built_in">source</span>: filename</span><br><span class="line">                expression: <span class="string">"^/works/log/(?P&lt;org&gt;.+?)/(?P&lt;env&gt;.+?)/(?P&lt;app_name&gt;.+?)/.+\\.log$"</span></span><br><span class="line">            - labels:</span><br><span class="line">                org:</span><br><span class="line">                env:</span><br><span class="line">                app_name:</span><br><span class="line">        - match:</span><br><span class="line">            selector: <span class="string">'&#123;org=~".+"&#125;'</span></span><br><span class="line">            stages:</span><br><span class="line">            - multiline:</span><br><span class="line">                firstline: <span class="string">'^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125; \d&#123;1,2&#125;:\d&#123;2&#125;:\d&#123;2&#125;'</span></span><br><span class="line">                max_lines: 500</span><br><span class="line">            - regex:</span><br><span class="line">                expression: <span class="string">"^(?P&lt;time&gt;\\d&#123;4&#125;\\-\\d&#123;2&#125;\\-\\d&#123;2&#125; \\d&#123;1,2&#125;\\:\\d&#123;2&#125;\\:\\d&#123;2&#125;).*"</span></span><br><span class="line">            - timestamp:</span><br><span class="line">                <span class="built_in">source</span>: time</span><br><span class="line">                format: <span class="string">'2006-01-02 15:04:05'</span></span><br><span class="line">                location: Asia/Shanghai</span><br><span class="line">        static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - localhost</span><br><span class="line">          labels:</span><br><span class="line">            belongs: company</span><br><span class="line">            __path__: /works/<span class="built_in">log</span>/**/*.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<h3 id="Installation-1"><a href="#Installation-1" class="headerlink" title="Installation"></a>Installation</h3><p>Installing the revlant components:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /works/loki/</span><br><span class="line">helm upgrade --install loki-grafana grafana/ -n loki</span><br><span class="line">helm upgrade --install loki loki/ -n loki</span><br><span class="line"><span class="comment">#helm upgrade --install promtail promtail/ --set "loki.serviceName=loki" -n loki</span></span><br><span class="line"><span class="comment">#If deploying a individual machine, don't need "--set" parameter</span></span><br><span class="line"><span class="comment">#kubectl get nodes --show-labels</span></span><br><span class="line"><span class="comment">#helm upgrade --install promtail promtail/ -n loki --set nodeSelector."kubernetes\.io/hostname"=192.168.80.201</span></span><br><span class="line"><span class="comment">#helm upgrade --install promtail promtail/ -n loki --set nodeSelector."kubernetes\.io/hostname"=k8s-master-cluster</span></span><br><span class="line">helm upgrade --install promtail promtail/ -n loki</span><br><span class="line"></span><br><span class="line"><span class="comment">#Waiting all of the pods are ready:</span></span><br><span class="line">kubectl get pods -n loki -w</span><br><span class="line"></span><br><span class="line"><span class="comment">#grafana</span></span><br><span class="line"><span class="comment">#Getting the grafana password using this:</span></span><br><span class="line">kubectl get secret --namespace loki loki-grafana -o jsonpath=<span class="string">"&#123;.data.admin-password&#125;"</span> | base64 --decode ; <span class="built_in">echo</span></span><br><span class="line"><span class="comment">#Exposed 3000 port outsize so that you can access it on your browser:</span></span><br><span class="line">kubectl port-forward --namespace loki service/loki-grafana 3000:80 --address 0.0.0.0</span><br><span class="line">URL: http://192.168.80.98:3000/</span><br><span class="line">Datasource: http://loki:3100/</span><br><span class="line"></span><br><span class="line"><span class="comment">#Configure grafana</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Loki Kubernetes Logs</span></span><br><span class="line">k8s logs dashboard:</span><br><span class="line">https://grafana.com/grafana/dashboards/15141</span><br><span class="line"></span><br><span class="line"><span class="comment">#company Logs</span></span><br><span class="line">env:</span><br><span class="line">  Query: label_values(env)</span><br><span class="line">system:</span><br><span class="line">  Query: label_values(&#123;belongs=<span class="string">"company"</span>, filename=~<span class="string">".*<span class="variable">$&#123;env&#125;</span>.*"</span>&#125;, filename)</span><br><span class="line">  Regex: /works\/<span class="built_in">log</span>\/.+?\/.+?\/(.+?)\/.*/</span><br><span class="line">hostname:</span><br><span class="line">  Query: label_values(&#123;belongs=<span class="string">"company"</span>, filename=~<span class="string">".*<span class="variable">$&#123;env&#125;</span>/<span class="variable">$&#123;system&#125;</span>.*"</span>&#125;, hostname)</span><br><span class="line">filename:</span><br><span class="line">  Query: label_values(&#123;belongs=<span class="string">"company"</span>, filename=~<span class="string">".*<span class="variable">$&#123;env&#125;</span>/<span class="variable">$&#123;system&#125;</span>.*"</span>, filename!~<span class="string">".*(?:error|tmlog).*"</span>&#125;, filename)</span><br><span class="line">  Regex: /.*\/(.+\.<span class="built_in">log</span>)/</span><br><span class="line">search:</span><br><span class="line">  Type: Text box</span><br><span class="line">Log browser:</span><br><span class="line">  &#123;env=<span class="string">"<span class="variable">$&#123;env&#125;</span>"</span>, app_name=<span class="string">"<span class="variable">$&#123;system&#125;</span>"</span>, hostname=~<span class="string">".*<span class="variable">$&#123;hostname&#125;</span>.*"</span>, filename=~<span class="string">".*<span class="variable">$&#123;filename&#125;</span>.*"</span>&#125;|~<span class="string">"(?i)<span class="variable">$search</span>"</span></span><br></pre></td></tr></table></figure>
<h3 id="Uninstallation"><a href="#Uninstallation" class="headerlink" title="Uninstallation"></a>Uninstallation</h3><p>Uninstalling the revlant components:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">helm uninstall loki  -n loki</span><br><span class="line"><span class="comment">#kubectl -n loki delete pvc storage-loki-0</span></span><br><span class="line"><span class="comment">#rm -fr /data/data/loki-data/loki/</span></span><br><span class="line">helm uninstall promtail  -n loki</span><br><span class="line">helm uninstall loki-grafana  -n loki</span><br><span class="line"><span class="comment">#kubectl -n loki get pvc</span></span><br><span class="line">kubectl -n loki delete pvc loki-pv-claim</span><br><span class="line"><span class="comment">#kubectl -n loki get pv</span></span><br><span class="line">kubectl delete pv loki-pv-volume</span><br></pre></td></tr></table></figure>
<h2 id="Optimize"><a href="#Optimize" class="headerlink" title="Optimize"></a>Optimize</h2><p><a href="https://grafana.com/blog/2021/02/16/the-essential-config-settings-you-should-use-so-you-wont-drop-logs-in-loki/" target="_blank" rel="noopener">https://grafana.com/blog/2021/02/16/the-essential-config-settings-you-should-use-so-you-wont-drop-logs-in-loki/</a></p>
<h2 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h2><p>error: code = ResourceExhausted desc = trying to send message larger than max</p>
<ul>
<li><a href="https://blog.csdn.net/qq_41980563/article/details/122186703" target="_blank" rel="noopener">https://blog.csdn.net/qq_41980563/article/details/122186703</a></li>
</ul>
<p>429 Too Many Requests Ingestion rate limit exceeded</p>
<ul>
<li><a href="https://www.codeleading.com/article/71834625328/" target="_blank" rel="noopener">https://www.codeleading.com/article/71834625328/</a></li>
</ul>
<p>Maximum active stream limit exceeded</p>
<ul>
<li><a href="https://izsk.me/2021/03/18/Loki-Prombles/" target="_blank" rel="noopener">https://izsk.me/2021/03/18/Loki-Prombles/</a></li>
<li><a href="https://www.bboy.app/2020/07/08/%E4%BD%BF%E7%94%A8loki%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/" target="_blank" rel="noopener">https://www.bboy.app/2020/07/08/%E4%BD%BF%E7%94%A8loki%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/</a></li>
</ul>
<p>Loki: Bad Request. 400. invalid query, through</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/457985915" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/457985915</a></li>
<li><a href="https://blog.csdn.net/u010948569/article/details/108387324" target="_blank" rel="noopener">https://blog.csdn.net/u010948569/article/details/108387324</a></li>
</ul>
<p>insane quantity of files in chunks directory</p>
<ul>
<li><a href="https://github.com/grafana/loki/issues/1258" target="_blank" rel="noopener">https://github.com/grafana/loki/issues/1258</a></li>
</ul>
<p>Searching data slowly</p>
<p>This reason may occur by some inappropriate configured labels, using the following command to diagnose:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logcli series --analyze-labels &apos;&#123;app_name=&quot;hkcash-server&quot;&#125;&apos;</span><br></pre></td></tr></table></figure>
<p>You can  this article to see how to avoid this issue:</p>
<p><a href="https://grafana.com/docs/loki/latest/best-practices/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/best-practices/</a></p>
<h2 id="Alarmmanager"><a href="#Alarmmanager" class="headerlink" title="Alarmmanager"></a>Alarmmanager</h2><p><a href="https://www.bilibili.com/read/cv17329220" target="_blank" rel="noopener">https://www.bilibili.com/read/cv17329220</a></p>
<h2 id="Configuration-backup"><a href="#Configuration-backup" class="headerlink" title="Configuration backup"></a>Configuration backup</h2><p>Loki Config: <a href="/files/Loki-Log-System/Loki.zip">loki.zip</a></p>
<p>AlertManager Config: <a href="/files/Loki-Log-System/AlertManager.zip">AlertManager.zip</a></p>
<p>Grafana Config: <a href="/files/Loki-Log-System/grafana.tgz">grafana.tgz</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://grafana.com/docs/loki/latest/getting-started/get-logs-into-loki/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/getting-started/get-logs-into-loki/</a></li>
<li><a href="https://grafana.com/docs/loki/latest/fundamentals/labels/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/fundamentals/labels/</a></li>
<li><a href="https://grafana.com/docs/loki/latest/logql/log_queries/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/logql/log_queries/</a></li>
<li><a href="https://grafana.com/docs/loki/latest/clients/promtail/stages/multiline/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/clients/promtail/stages/multiline/</a></li>
<li><a href="https://grafana.com/docs/loki/latest/clients/promtail/stages/regex/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/clients/promtail/stages/regex/</a></li>
<li><a href="https://github.com/google/re2/wiki/Syntax" target="_blank" rel="noopener">https://github.com/google/re2/wiki/Syntax</a></li>
<li><a href="https://grafana.com/docs/grafana/latest/variables/" target="_blank" rel="noopener">https://grafana.com/docs/grafana/latest/variables/</a></li>
<li><a href="https://grafana.com/docs/grafana/latest/datasources/loki/" target="_blank" rel="noopener">https://grafana.com/docs/grafana/latest/datasources/loki/</a></li>
<li><a href="https://www.jianshu.com/p/474a5034a501" target="_blank" rel="noopener">https://www.jianshu.com/p/474a5034a501</a></li>
<li><a href="https://www.jianshu.com/p/259a1d656745" target="_blank" rel="noopener">https://www.jianshu.com/p/259a1d656745</a></li>
<li><a href="https://www.jianshu.com/p/672173b609f7" target="_blank" rel="noopener">https://www.jianshu.com/p/672173b609f7</a></li>
<li><a href="https://www.cnblogs.com/ssgeek/p/11584870.html" target="_blank" rel="noopener">https://www.cnblogs.com/ssgeek/p/11584870.html</a></li>
<li><a href="https://grafana.com/docs/loki/latest/installation/helm/" target="_blank" rel="noopener">https://grafana.com/docs/loki/latest/installation/helm/</a></li>
<li><a href="https://blog.csdn.net/weixin_49366475/article/details/114384817" target="_blank" rel="noopener">https://blog.csdn.net/weixin_49366475/article/details/114384817</a></li>
<li><a href="https://blog.luxifan.com/blog/post/lucifer/1.%E5%88%9D%E8%AF%86Loki-%E4%B8%80" target="_blank" rel="noopener">https://blog.luxifan.com/blog/post/lucifer/1.%E5%88%9D%E8%AF%86Loki-%E4%B8%80</a></li>
<li><a href="https://blog.csdn.net/bluuusea/article/details/104619235" target="_blank" rel="noopener">https://blog.csdn.net/bluuusea/article/details/104619235</a></li>
<li><a href="https://blog.51cto.com/u_14205795/4561323" target="_blank" rel="noopener">https://blog.51cto.com/u_14205795/4561323</a></li>
<li><a href="https://www.cnblogs.com/punchlinux/p/17035742.html" target="_blank" rel="noopener">https://www.cnblogs.com/punchlinux/p/17035742.html</a></li>
<li><a href="https://kebingzao.com/2022/11/29/prometheus-4-alertmanager/" target="_blank" rel="noopener">https://kebingzao.com/2022/11/29/prometheus-4-alertmanager/</a></li>
<li><a href="https://blog.csdn.net/wang7531838/article/details/107809870" target="_blank" rel="noopener">https://blog.csdn.net/wang7531838/article/details/107809870</a></li>
<li><a href="https://blog.51cto.com/u_12965094/2690336" target="_blank" rel="noopener">https://blog.51cto.com/u_12965094/2690336</a></li>
<li><a href="https://blog.csdn.net/qq_42883074/article/details/115544031" target="_blank" rel="noopener">https://blog.csdn.net/qq_42883074/article/details/115544031</a></li>
<li><a href="https://blog.csdn.net/bluuusea/article/details/104619235" target="_blank" rel="noopener">https://blog.csdn.net/bluuusea/article/details/104619235</a></li>
<li><a href="http://www.mydlq.club/article/126/" target="_blank" rel="noopener">http://www.mydlq.club/article/126/</a></li>
<li><a href="https://www.orchome.com/10106" target="_blank" rel="noopener">https://www.orchome.com/10106</a></li>
<li><a href="https://blog.51cto.com/u_14320361/2461666" target="_blank" rel="noopener">https://blog.51cto.com/u_14320361/2461666</a></li>
<li><a href="https://chenzhonzhou.github.io/2020/07/17/alertmanager-de-gao-jing-mo-ban/" target="_blank" rel="noopener">https://chenzhonzhou.github.io/2020/07/17/alertmanager-de-gao-jing-mo-ban/</a></li>
<li><a href="https://blog.csdn.net/weixin_44911287/article/details/124149964" target="_blank" rel="noopener">https://blog.csdn.net/weixin_44911287/article/details/124149964</a></li>
<li><a href="https://blog.csdn.net/easylife206/article/details/127581630" target="_blank" rel="noopener">https://blog.csdn.net/easylife206/article/details/127581630</a></li>
</ul>
<p>kubectl create ns zero-loki<br>kubectl -n zero-loki create configmap –from-file configmap/loki-config-cluster.yaml loki-config<br>kubectl -n zero-loki create configmap –from-file configmap/rules.yaml loki-rules</p>
<p>kubectl -n zero-loki describe configmap loki-config<br>kubectl -n zero-loki describe configmap loki-rules</p>
<p>kubectl -n zero-loki apply -f zero-loki.yml</p>
<p>kubectl -n zero-loki get po,svc -owide</p>
<p>#kubectl -n zero-loki logs -f loki-cluster-57777d6d6-vkbc5</p>
<p>#kubectl -n zero-loki describe po loki-cluster-57777d6d6-8tfgd</p>
<blockquote>
<p>kubectl.exe -n zero-loki exec -it kafka-0 bash<br>kafka-topics.sh –create –zookeeper “zookeeper-headless:2181” –replication-factor 2 –partitions 3 –topic uat<br>kafka-console-producer.sh –broker-list “192.168.80.99:9192,192.168.80.99:9292,192.168.80.99:9392” –topic uat<br>kafka-console-consumer.sh –bootstrap-server “192.168.80.99:9192,192.168.80.99:9292,192.168.80.99:9392” –topic uat –from-beginning<br>kafka-topics.sh –list –zookeeper “zookeeper-headless:2181”</p>
</blockquote>
<p>kafka-run-class.sh kafka.tools.GetOffsetShell –broker-list “192.168.80.99:9192,192.168.80.99:9292,192.168.80.99:9392” –topic uat</p>
<p>kubectl -n xpay-logs run -ti –rm centos-test –image=centos:7 –overrides=’{“spec”: { “nodeSelector”: {“xpay-env”: “logs”}}}’</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Log/" rel="tag"># Log</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/istio学习总结.html" rel="next" title="istio学习总结">
                <i class="fa fa-chevron-left"></i> istio学习总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/04/A-Guide-to-Vagrant.html" rel="prev" title="A Guide to Vagrant">
                A Guide to Vagrant <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MTc1MS8xODI5Nw=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zhaoxunyong</p>
              <p class="site-description motion-element" itemprop="description">平时工作中所遇到的一些问题的总结</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://subblogzhaoxunyongm70.lofter.com/" title="lofter" target="_blank">lofter</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#kafka"><span class="nav-number">1.</span> <span class="nav-text">kafka</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Kakfa-k8s"><span class="nav-number">1.1.</span> <span class="nav-text">Kakfa k8s</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper"><span class="nav-number">2.</span> <span class="nav-text">Zookeeper</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Loki"><span class="nav-number">3.</span> <span class="nav-text">Loki</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Installation"><span class="nav-number">3.1.</span> <span class="nav-text">Installation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Docker"><span class="nav-number">3.1.1.</span> <span class="nav-text">Docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Collecting-type"><span class="nav-number">3.1.2.</span> <span class="nav-text">Collecting type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-compose"><span class="nav-number">3.1.3.</span> <span class="nav-text">docker-compose</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Grafana-Configuration"><span class="nav-number">3.1.4.</span> <span class="nav-text">Grafana Configuration</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#promtail"><span class="nav-number">4.</span> <span class="nav-text">promtail</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Configuration"><span class="nav-number">5.</span> <span class="nav-text">Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Promtail-Config"><span class="nav-number">5.1.</span> <span class="nav-text">Promtail Config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grafana-Config"><span class="nav-number">5.2.</span> <span class="nav-text">Grafana Config</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Variables"><span class="nav-number">5.2.1.</span> <span class="nav-text">Variables</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Log-Panel"><span class="nav-number">5.2.2.</span> <span class="nav-text">Log Panel</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes"><span class="nav-number">6.</span> <span class="nav-text">Kubernetes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Heml"><span class="nav-number">6.1.</span> <span class="nav-text">Heml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Installation-1"><span class="nav-number">6.2.</span> <span class="nav-text">Installation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Uninstallation"><span class="nav-number">6.3.</span> <span class="nav-text">Uninstallation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Optimize"><span class="nav-number">7.</span> <span class="nav-text">Optimize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshooting"><span class="nav-number">8.</span> <span class="nav-text">Troubleshooting</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Alarmmanager"><span class="nav-number">9.</span> <span class="nav-text">Alarmmanager</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Configuration-backup"><span class="nav-number">10.</span> <span class="nav-text">Configuration backup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">11.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhaoxunyong</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("jozwrL8uJ20tiwfpIlilQEvx-gzGzoHsz", "DrpiYQlTyseBEjF9Ujr0SVKk");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
